name: Auto Generate Index

on:
  push:
    paths:
      - '**/*.html' # 监听所有文件夹下的 html 变动
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Generate index.html
        run: |
          python3 -c "
          import os

          repo_url = 'https://cooanyh.github.io/my-service/'
          
          # 收集到的文件列表
          links = []

          # os.walk 会递归遍历所有子目录
          for root, dirs, files in os.walk('.'):
              # 排除 .git 目录
              if '.git' in dirs:
                  dirs.remove('.git')
              
              for f in files:
                  # 排除 index.html 自身，避免死循环引用
                  if f.endswith('.html') and f != 'index.html':
                      # 获取相对路径，例如 'folder/subfolder'
                      rel_path = os.path.relpath(root, '.')
                      
                      if rel_path == '.':
                          # 根目录文件
                          full_path = f
                          display_name = f
                      else:
                          # 子目录文件，统一路径分隔符为 /
                          full_path = os.path.join(rel_path, f).replace(os.sep, '/')
                          display_name = full_path

                      links.append({'path': full_path, 'name': display_name})

          # 按路径名称排序，让列表整齐
          links.sort(key=lambda x: x['path'])

          html_content = '''
          <!DOCTYPE html>
          <html lang=\"zh-CN\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>My Service Index</title>
              <style>
                  body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; color: #333; line-height: 1.6; }
                  h1 { border-bottom: 1px solid #eee; padding-bottom: 10px; }
                  ul { list-style: none; padding: 0; }
                  li { border-bottom: 1px solid #f0f0f0; }
                  a { text-decoration: none; color: #0969da; display: block; padding: 10px 5px; transition: background 0.2s; }
                  a:hover { background: #f6f8fa; padding-left: 10px; }
                  .meta { font-size: 0.8em; color: #666; margin-bottom: 20px; }
              </style>
          </head>
          <body>
              <h1>My Service Pages</h1>
              <div class=\"meta\">
                  Root: <a href=\"''' + repo_url + '''\" style=\"display:inline; border:none; padding:0;\">''' + repo_url + '''</a>
              </div>
              <ul>
          '''
          
          for link in links:
              # 拼接完整 URL
              url = repo_url + link['path']
              html_content += f'<li><a href=\"{url}\" target=\"_blank\">{link[\"name\"]}</a></li>'
              
          html_content += '''
              </ul>
              <p style=\"color:#999; font-size:0.75em; margin-top:30px; border-top:1px solid #eee; padding-top:10px;\">
                  Auto-generated by GitHub Actions
              </p>
          </body>
          </html>
          '''
          
          with open('index.html', 'w', encoding='utf-8') as f:
              f.write(html_content)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          # 强制添加 index.html，防止被 .gitignore 忽略
          git add index.html
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update index with subdirectories" && git push)

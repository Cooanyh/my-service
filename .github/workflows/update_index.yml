name: Auto Generate List Page

on:
  push:
    paths:
      - '**/*.html'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Generate list.html
        run: |
          python3 -c "
          import os

          output_filename = 'list.html'
          repo_url = 'https://cooanyh.github.io/my-service/'
          
          links = []

          for root, dirs, files in os.walk('.'):
              if '.git' in dirs:
                  dirs.remove('.git')
              
              for f in files:
                  if f.endswith('.html') and f != output_filename:
                      rel_path = os.path.relpath(root, '.')
                      if rel_path == '.':
                          full_path = f
                          display_name = f
                      else:
                          full_path = os.path.join(rel_path, f).replace(os.sep, '/')
                          display_name = full_path

                      links.append({'path': full_path, 'name': display_name})

          links.sort(key=lambda x: x['path'])

          # 注意：下面这段 HTML 里的变量只会用单层花括号 {}
          html_content = f'''
          <!DOCTYPE html>
          <html lang=\"zh-CN\">
          <head>
              <meta charset=\"UTF-8\">
              <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
              <title>Site Map</title>
              <style>
                  body {{ font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; line-height: 1.6; }}
                  a {{ text-decoration: none; color: #0969da; display: block; padding: 5px 0; border-bottom: 1px solid #eee; }}
                  a:hover {{ background: #f6f8fa; }}
              </style>
          </head>
          <body>
              <h1>网页文件清单</h1>
              <p>Total files: {len(links)}</p>
              <ul>
          '''
          
          for link in links:
              url = repo_url + link['path']
              # 这里修正了：去掉了多余的花括号，能正确显示文件名和链接了
              html_content += f'<li><a href=\"{url}\" target=\"_blank\">{link[\"name\"]}</a></li>'
              
          html_content += '''
              </ul>
          </body>
          </html>
          '''
          
          with open(output_filename, 'w', encoding='utf-8') as f:
              f.write(html_content)
          "

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add list.html
          if git commit -m "Update list.html"; then
            git pull --rebase origin main
            git push origin HEAD:main
          else
            echo "No changes to commit"
          fi

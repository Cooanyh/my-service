<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Music-video</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <!-- PWA and Mobile Optimization -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Music Video">
    <meta name="application-name" content="Music Video">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1a1a1a/ffffff?text=MV">
    <link rel="manifest" id="manifest-placeholder">
    <script>
        // 改进的 PWA manifest.json 配置
        const manifestContent = {
            "name": "Music Video Player - 音乐视频播放器",
            "short_name": "MusicVideo",
            "description": "沉浸式音乐视频播放器，支持歌词显示、背景切换和时间屏保",
            "start_url": "./winlyrics-video.html",
            "scope": "./",
            "display": "standalone",
            "background_color": "#1a1a1a",
            "theme_color": "#1a1a1a",
            "orientation": "any",
            "categories": ["music", "entertainment"],
            "lang": "zh-CN",
            "dir": "ltr",
            "icons": [
                {
                    "src": "https://placehold.co/72x72/1a1a1a/00d26a?text=MV",
                    "sizes": "72x72",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/96x96/1a1a1a/00d26a?text=MV",
                    "sizes": "96x96",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/128x128/1a1a1a/00d26a?text=MV",
                    "sizes": "128x128",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/144x144/1a1a1a/00d26a?text=MV",
                    "sizes": "144x144",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/152x152/1a1a1a/00d26a?text=MV",
                    "sizes": "152x152",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/192x192/1a1a1a/00d26a?text=MV",
                    "sizes": "192x192",
                    "type": "image/png",
                    "purpose": "any maskable"
                },
                {
                    "src": "https://placehold.co/384x384/1a1a1a/00d26a?text=MV",
                    "sizes": "384x384",
                    "type": "image/png",
                    "purpose": "any"
                },
                {
                    "src": "https://placehold.co/512x512/1a1a1a/00d26a?text=MV",
                    "sizes": "512x512",
                    "type": "image/png",
                    "purpose": "any maskable"
                }
            ],
            "shortcuts": [
                {
                    "name": "播放音乐",
                    "short_name": "播放",
                    "description": "直接打开音乐播放器",
                    "url": "./winlyrics-video.html",
                    "icons": [
                        {
                            "src": "https://placehold.co/96x96/1a1a1a/00d26a?text=Play",
                            "sizes": "96x96",
                            "type": "image/png"
                        }
                    ]
                }
            ],
            "screenshots": [
                {
                    "src": "https://placehold.co/1080x1920/1a1a1a/00d26a?text=MusicVideo",
                    "sizes": "1080x1920",
                    "type": "image/png",
                    "form_factor": "narrow",
                    "label": "音乐播放界面"
                },
                {
                    "src": "https://placehold.co/1920x1080/1a1a1a/00d26a?text=MusicVideo",
                    "sizes": "1920x1080",
                    "type": "image/png",
                    "form_factor": "wide",
                    "label": "桌面播放界面"
                }
            ]
        };

        // 创建Blob并设置manifest链接
        const manifestBlob = new Blob([JSON.stringify(manifestContent)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <!-- Microsoft Edge PWA 支持 -->
    <meta name="msapplication-TileColor" content="#1a1a1a">
    <meta name="msapplication-TileImage" content="https://placehold.co/144x144/1a1a1a/ffffff?text=MV">
    <meta name="msapplication-config" content="none">
    <meta name="msapplication-starturl" content="./index.html">
    <meta name="msapplication-navbutton-color" content="#1a1a1a">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- All preset fonts are now loaded here -->
    <link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Zhi+Mang+Xing&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Liu+Jian+Mao+Cao&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,200..900&display=swap"
        rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400..700&display=swap" rel="stylesheet">
    <!-- 时间屏保字体 -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap"
        rel="stylesheet">


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- Placeholder for custom font styles -->
    <style id="custom-font-styles"></style>

    <style>
        :root {
            color-scheme: dark;
            --animation-duration: 0.8s;
            --chinese-font-family: 'Ma Shan Zheng';
            --english-font-family: 'Roboto';
            --theme-primary: rgb(0, 102, 51);
            /* 新增：时间屏保字体变量 */
            --screensaver-font-family: var(--chinese-font-family);
        }

        /* 手动标记资源状态的样式 */
        .manual-label {
            color: #2ecc71;
            font-weight: bold;
        }

        .validate-btn {
            background-color: #2ecc71 !important;
            color: white !important;
            border: none;
            border-radius: 3px;
            padding: 2px 5px;
            margin-right: 3px;
            cursor: pointer;
        }

        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            touch-action: manipulation;
            overscroll-behavior-y: contain;
        }

        html.no-cursor,
        html.no-cursor * {
            cursor: none;
        }

        body {
            background-color: #1a1a1a;
            font-family: var(--chinese-font-family), 'Noto Sans SC', 'Segoe UI', Arial, sans-serif;
            color: #ffffff;
            display: flex;
            align-items: flex-end;
            justify-content: flex-start;
            user-select: none;
            -moz-user-select: none;
            -webkit-user-select: none;
            -ms-user-select: none;
            perspective: 800px;
        }

        #bg-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center center;
            /* [修复] 图片直接交叉淡入淡出：移除容器的 opacity 过渡 */
            /* transition: opacity 0.4s ease-in-out; */
            /* [修复] 新增：为伪元素准备 */
            overflow: hidden;
            /* 防止缩放动画溢出 */
            /* [修复] 定义 CSS 变量，用于 JS 设置伪元素背景 */
            --before-bg-image: none;
        }

        /* [修复] 新增：用于交叉淡入淡出的伪元素 */
        #bg-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
            /* 控制淡出速度 */
            z-index: -2;
            /* 确保在主容器后面 */
            background-image: var(--before-bg-image);
        }

        #bg-container.crossfading::before {
            opacity: 1;
            /* 当添加此类时，伪元素立即变为可见 (显示旧图) */
        }

        /* 内容突出显示蒙版 */
        #content-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: rgba(0, 0, 0, 0.5);
            /* 默认透明度 */
            pointer-events: none;
            /* 允许点击穿透 */
            opacity: 0;
            /* 默认不显示 */
            transition: opacity 0.3s ease;
        }

        #content-overlay.active {
            opacity: 1;
        }

        @keyframes bg-zoom {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        #bg-container.animated {
            animation: bg-zoom 25s infinite ease-in-out;
        }

        #bg-video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translateX(-50%) translateY(-50%);
            object-fit: cover;
            opacity: 1;
            transition: opacity 0.5s ease-in-out;
        }

        .main-container {
            width: auto;
            padding: 0 0 10vh 8vw;
            box-sizing: border-box;
            position: relative;
            z-index: 1;
        }

        #lyricsDisplay {
            opacity: 0;
            text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        /* Rule removed during revert */

        .lyric-line-top,
        .lyric-line-bottom {
            display: flex;
            align-items: baseline;
            white-space: nowrap;
        }

        .lyric-line-top {
            margin-bottom: 0.25em;
        }

        .lyric-part {
            font-weight: normal;
            line-height: 1.4;
            transition: font-size 0.4s ease;
            will-change: transform, opacity;
            /* 优化：提示浏览器提前优化渲染 */
        }

        /* 移除整体切换字体的样式，改为使用span标签分别应用不同字体 */
        .lyric-part .chinese-char {
            font-family: var(--chinese-font-family), 'Noto Sans SC', 'Segoe UI', Arial, sans-serif;
        }

        .lyric-part .english-char {
            font-family: var(--english-font-family), 'Segoe UI', Arial, sans-serif;
        }

        .lyric-top-part {
            font-size: 3.5em;
        }

        .lyric-top-part.larger {
            font-size: 4.375em;
        }

        #lyric-top-separator {
            font-size: 2.8em;
            margin: 0 0.4em;
            display: none;
        }

        #lyric-placeholder,
        #lyric-bottom-separator {
            font-size: 1.1em;
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            color: rgba(255, 255, 255, 0.8);
            letter-spacing: 2px;
            text-transform: uppercase;
            font-weight: 500;
        }

        #lyric-bottom-separator {
            margin: 0 0.5em;
        }

        #lyric-bottom-part {
            font-size: 2.5em;
        }

        .lyric-fly-in {
            opacity: 1 !important;
        }

        /* --- Lyric Animation Styles --- */
        /* Original "Subtle" Keyframes */
        @keyframes smoothEntranceTop {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
                filter: blur(3px);
                text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5);
            }

            30% {
                opacity: 1;
                filter: blur(0);
                text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.8);
            }

            /* 上面一行可以调整微妙模式歌词出现动画速率，30%慢2个字符 */
            100% {
                transform: translateY(0) scale(1.05);
                text-shadow: 0 0 12px rgba(0, 0, 0, 0.6), 0 0 20px rgba(0, 0, 0, 0.5), 3px 3px 15px rgba(0, 0, 0, 0.9);
            }
        }

        @keyframes smoothEntranceBottom {
            0% {
                opacity: 0;
                transform: translateX(-20px) scale(0.98);
                filter: blur(2px);
                text-shadow: 3px 3px 8px rgba(0, 0, 0, 0.5);
            }

            30% {
                opacity: 1;
                filter: blur(0);
                text-shadow: 3px 3px 10px rgba(0, 0, 0, 0.8);
            }

            /* 上面一行可以调整微妙模式歌词出现动画速率，30%慢2个字符 */
            100% {
                transform: translateX(0) scale(1.03);
                text-shadow: 0 0 8px rgba(0, 0, 0, 0.5), 0 0 16px rgba(0, 0, 0, 0.4), 3px 3px 12px rgba(0, 0, 0, 0.9);
            }
        }

        /* "Dynamic" Keyframes */
        @keyframes lyricAnimation-Dynamic {
            from {
                opacity: 0;
                transform: translateY(25px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Subtle Entrance (Original) */
        .lyric-anim-subtle .lyric-fly-in .lyric-line-top {
            opacity: 0;
            animation: smoothEntranceTop 9.8s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        .lyric-anim-subtle .lyric-fly-in .lyric-line-bottom {
            opacity: 0;
            animation: smoothEntranceBottom 8.9s cubic-bezier(0.19, 1, 0.22, 1) 0.1s forwards;
        }

        /* Dynamic Entrance */
        .lyric-anim-dynamic .lyric-fly-in .lyric-line-top,
        .lyric-anim-dynamic .lyric-fly-in .lyric-line-bottom {
            opacity: 0;
            animation: lyricAnimation-Dynamic 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .lyric-anim-dynamic .lyric-fly-in .lyric-line-bottom {
            animation-delay: 0.1s;
        }

        #songInfoDisplay {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: auto;
            text-align: right;
            color: rgba(255, 255, 255, 0.9);
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            font-size: 1em;
            font-weight: 400;
            text-shadow: 1px 1px 4px rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        #myhkplayer_video {
            display: none !important;
        }

        .switch-player {
            opacity: 0 !important;
        }

        .toast-notification,
        .volume-bar-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 22px;
            border-radius: 25px;
            z-index: 1003;
            opacity: 0;
            transition: opacity 0.4s ease-in-out, bottom 0.4s ease-in-out;
            pointer-events: none;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
        }

        .volume-bar-container {
            width: 200px;
            padding: 12px 15px;
        }

        .volume-bar-inner {
            width: 100%;
            height: 6px;
            background-color: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .volume-bar-fill {
            height: 100%;
            background-color: white;
            border-radius: 3px;
            width: 50%;
            transition: width 0.1s linear;
        }

        /* New Player Controls Styles */
        #player-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 12px;
            /* Rounded corners */
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .control-btn.play {
            width: 54px;
            height: 54px;
            font-size: 22px;
            background: var(--theme-primary);
            border-color: var(--theme-primary);
        }

        .control-btn.play:hover {
            filter: brightness(1.05);
        }

        .control-btn {
            transition: transform .15s ease, filter .2s ease;
        }

        .control-btn:hover {
            transform: translateY(-1px);
        }

        .context-menu {
            position: fixed;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            color: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.5);
            min-width: 220px;
            overflow: hidden;
            display: none;
            transform: scale(0.98);
            opacity: 0;
            transition: transform .15s ease, opacity .15s ease;
        }

        .context-menu.open {
            transform: scale(1);
            opacity: 1;
        }

        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .context-menu-item:last-child {
            border-bottom: none;
        }

        .context-menu-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        @media (max-width: 1024px) {
            .lyric-top-part {
                font-size: 3em;
            }

            .lyric-top-part.larger {
                font-size: 3.75em;
            }

            #lyric-top-separator {
                font-size: 2.4em;
            }

            #lyric-bottom-part {
                font-size: 2.2em;
            }
        }

        @media (max-width: 768px) {
            .lyric-top-part {
                font-size: 2.8em;
            }

            .lyric-top-part.larger {
                font-size: 3.5em;
            }

            #lyric-top-separator {
                font-size: 2.2em;
            }

            #lyric-bottom-part {
                font-size: 2em;
            }
        }

        @media (max-width: 480px) {
            body {
                justify-content: center;
            }

            .main-container {
                padding: 0 5vw 15vh 5vw;
                width: 100%;
                box-sizing: border-box;
            }

            #lyricsDisplay,
            .lyric-line-top,
            .lyric-line-bottom {
                align-items: center;
                justify-content: center;
                width: 100%;
                text-align: center;
            }

            .lyric-line-top,
            .lyric-line-bottom {
                white-space: normal;
                flex-wrap: wrap;
            }

            .lyric-top-part {
                font-size: 2.3em;
            }

            .lyric-top-part.larger {
                font-size: 2.9em;
            }

            #lyric-top-separator {
                font-size: 2em;
            }

            #lyric-bottom-part {
                font-size: 1.7em;
            }

            #songInfoDisplay {
                width: 90%;
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
                bottom: 20px;
            }
        }

        /* ============== 时间屏保样式 (已优化) ============== */
        #time-screensaver {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            /* 优化：动画起始状态 */
            z-index: 5;
            color: white;
            text-shadow: 3px 3px 15px rgba(0, 0, 0, 0.7);
            text-align: center;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: var(--screensaver-font-family);
            white-space: nowrap;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            /* 优化：增加 transform 过渡 */
            opacity: 0;
        }

        #time-screensaver.visible {
            display: flex;
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
            /* 优化：动画结束状态 */
        }

        #time-display {
            line-height: 1;
        }

        #date-display {
            line-height: 1.2;
            opacity: 0.8;
            margin-top: 0.5em;
        }

        /* 为不同风格应用特定字体 */
        #time-screensaver.style-modern {
            font-family: 'Montserrat', 'Inter', 'Roboto', sans-serif;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        #time-screensaver.style-modern #time-display {
            font-family: 'Montserrat', monospace;
            font-variant-numeric: tabular-nums;
            min-width: 6em;
            /* 固定最小宽度，防止长度变化 */
            text-align: center;
        }

        #time-screensaver.style-western {
            font-family: 'Cormorant Garamond', serif;
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        #time-screensaver.style-western #time-display {
            font-family: 'Cormorant Garamond', monospace;
            font-variant-numeric: tabular-nums;
            min-width: 8em;
            /* 固定最小宽度，防止长度变化 */
            text-align: center;
        }

        #time-screensaver.style-ancient .ancient-digit {
            font-family: 'Roboto', 'Helvetica Neue', sans-serif;
        }

        #time-display .ancient-seconds {
            font-size: 0.3em;
            opacity: 0.7;
            vertical-align: middle;
            margin-left: 0.2em;
        }

        #time-display .ancient-seconds::before {
            content: '·';
            margin-right: 0.1em;
        }


        /* ============== 设置面板样式 (Premium Glassmorphism) ============== */
        :root {
            --glass-bg: rgba(30, 30, 30, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.12);
            --accent-color: #00d26a;
            --text-main: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --radius-lg: 24px;
            --radius-md: 16px;
            --radius-sm: 12px;
            --shadow-lg: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        #settings-hot-zone {
            position: fixed;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            z-index: 999;
            display: flex;
            justify-content: flex-end;
            align-items: flex-start;
            padding: 20px;
            box-sizing: border-box;
        }

        #settings-button {
            width: 48px;
            height: 48px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            background-color: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            transform: scale(0.9);
        }

        #settings-hot-zone:hover #settings-button {
            opacity: 1;
            transform: scale(1);
        }

        #settings-button:hover {
            background-color: var(--glass-highlight);
            transform: scale(1.1);
        }

        #settings-button svg {
            width: 24px;
            height: 24px;
            fill: var(--text-main);
            transition: transform 0.5s ease;
        }

        #settings-button:hover svg {
            transform: rotate(90deg);
        }

        #password-modal,
        #settings-panel,
        #video-preview-modal,
        #playlist-view-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            align-items: center;
            justify-content: center;
            font-family: 'Inter', 'Roboto', 'Noto Sans SC', sans-serif;
            z-index: 1001;
            opacity: 0;
            transition: opacity 0.3s ease;
            will-change: opacity, transform;
            /* 优化：提示浏览器提前优化渲染 */
        }

        #password-modal.active,
        #settings-panel.active,
        #video-preview-modal.active,
        #playlist-view-modal.active {
            opacity: 1;
        }

        #password-modal,
        #video-preview-modal,
        #playlist-view-modal {
            z-index: 1002;
        }

        .settings-container {
            width: 90%;
            max-width: 1100px;
            height: 85vh;
            max-height: 800px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: row;
            position: relative;
            overflow: hidden;
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.22, 1, 0.36, 1);
        }

        #settings-panel.active .settings-container {
            transform: scale(1);
        }

        .settings-sidebar {
            width: 280px;
            flex-shrink: 0;
            background: rgba(0, 0, 0, 0.2);
            border-right: 1px solid var(--glass-border);
            padding: 30px 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .sidebar-header {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 30px;
            padding-left: 15px;
            color: var(--text-main);
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-nav-btn {
            padding: 14px 20px;
            border-radius: var(--radius-sm);
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1em;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: transparent;
            border: none;
            text-align: left;
            width: 100%;
        }

        .sidebar-nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-main);
        }

        .sidebar-nav-btn.active {
            background: var(--glass-highlight);
            color: var(--text-main);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .sidebar-nav-btn i {
            width: 20px;
            text-align: center;
            font-size: 1.1em;
        }

        .settings-main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            background: transparent;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 40px;
            border-bottom: 1px solid var(--glass-border);
            background: rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }

        .mobile-tab-bar {
            display: none;
        }

        .settings-header-mobile {
            display: none;
            padding: 20px;
            border-bottom: 1px solid var(--glass-border);
            align-items: center;
            justify-content: space-between;
        }

        .modal-close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--glass-border);
            color: var(--text-secondary);
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            z-index: 10;
        }

        .modal-close-btn:hover {
            background: rgba(255, 59, 48, 0.2);
            color: #ff3b30;
            border-color: rgba(255, 59, 48, 0.3);
            transform: rotate(90deg);
        }

        .settings-content {
            overflow-y: auto;
            flex-grow: 1;
            padding: 40px;
            scroll-behavior: smooth;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .settings-section {
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: var(--radius-md);
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.03);
        }

        .settings-section h4 {
            font-size: 1.1em;
            margin: 0 0 20px 0;
            color: var(--accent-color);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .settings-section h4::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, var(--glass-border), transparent);
        }

        .form-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .form-group.vertical {
            flex-direction: column;
            align-items: stretch;
        }

        .form-group.grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group label {
            color: var(--text-secondary);
            font-size: 0.95em;
            font-weight: 500;
        }

        input[type="text"],
        input[type="url"],
        input[type="number"],
        input[type="password"],
        input[type="search"],
        textarea,
        select {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            padding: 12px 16px;
            border-radius: var(--radius-sm);
            font-size: 0.95em;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.2s;
            font-family: inherit;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: var(--accent-color);
            background: rgba(0, 0, 0, 0.5);
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 210, 106, 0.1);
        }

        button {
            padding: 10px 20px;
            background: var(--glass-highlight);
            color: var(--text-main);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(1px);
        }

        button.primary-btn {
            background: var(--accent-color);
            color: #000;
            border: none;
            font-weight: 600;
        }

        button.primary-btn:hover {
            background: #00e676;
            box-shadow: 0 4px 15px rgba(0, 210, 106, 0.3);
        }

        button.danger-btn {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border-color: rgba(255, 59, 48, 0.3);
        }

        button.danger-btn:hover {
            background: rgba(255, 59, 48, 0.2);
            border-color: #ff3b30;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 46px;
            height: 26px;
            flex-shrink: 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.1);
            transition: .3s;
            border-radius: 34px;
            border: 1px solid var(--glass-border);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s cubic-bezier(0.4, 0.0, 0.2, 1);
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked+.slider {
            background-color: var(--accent-color);
            border-color: var(--accent-color);
        }

        input:checked+.slider:before {
            transform: translateX(20px);
            background-color: #fff;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 768px) {
            .settings-container {
                width: 100%;
                height: 100%;
                max-height: none;
                border-radius: 0;
                flex-direction: column;
            }

            .settings-sidebar {
                display: none;
            }

            .settings-main-content {
                flex: 1;
                display: flex;
                flex-direction: column;
                min-height: 0;
                overflow: hidden;
            }

            .settings-header-mobile {
                display: flex;
                background: rgba(0, 0, 0, 0.3);
            }

            .settings-content {
                padding: 20px;
                overflow-y: auto !important;
                flex: 1;
                min-height: 0;
                -webkit-overflow-scrolling: touch;
            }

            .form-group.grid-2 {
                grid-template-columns: 1fr;
            }

            .mobile-tab-bar {
                display: flex;
                overflow-x: auto;
                background: rgba(0, 0, 0, 0.4);
                padding: 10px;
                gap: 10px;
                border-bottom: 1px solid var(--glass-border);
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                flex-shrink: 0;
            }

            .mobile-tab-btn {
                padding: 8px 16px;
                border-radius: 20px;
                background: rgba(255, 255, 255, 0.05);
                color: var(--text-secondary);
                border: 1px solid transparent;
                font-size: 0.9em;
            }

            .mobile-tab-btn.active {
                background: var(--accent-color);
                color: #000;
                font-weight: 600;
            }

            .settings-header {
                flex-shrink: 0;
            }
        }

        .custom-file-upload {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            border: 2px dashed var(--glass-border);
            border-radius: var(--radius-md);
            background: rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            color: var(--text-secondary);
        }

        .custom-file-upload:hover {
            border-color: var(--accent-color);
            background: rgba(0, 210, 106, 0.05);
            color: var(--accent-color);
        }

        #player-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 20px 0;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            /* 改为方形圆角 */
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            transition: all 0.2s;
        }

        .control-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.1);
        }

        .control-btn.play {
            width: 64px;
            height: 64px;
            background: var(--accent-color);
            color: #000;
            font-size: 1.5em;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 210, 106, 0.4);
        }

        .control-btn.play:hover {
            background: #00e676;
            transform: scale(1.1);
        }

        .video-list-item {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }

        .video-list-item:hover {
            background: rgba(255, 255, 255, 0.06);
            transform: translateX(5px);
        }

        .progress-container {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: var(--radius-sm);
            display: flex;
            /* 修复：使用 Flex 布局 */
            align-items: center;
            gap: 15px;
        }

        .progressbg {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            flex: 1;
            /* 修复：让进度条占据剩余空间 */
            position: relative;
            /* 确保子元素绝对定位正确 */
            cursor: pointer;
        }

        .progressbg1 {
            background: var(--accent-color);
            box-shadow: 0 0 10px rgba(0, 210, 106, 0.5);
        }

        .ts {
            width: 14px;
            height: 14px;
            background: #fff;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            /* 圆形 */
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            margin-left: -7px;
            /* 居中 */
            transition: left 0.1s linear;
        }

        /* 播放列表视图模态框样式 */
        .playlist-view-container {
            background: rgba(20, 20, 30, 0.98);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .playlist-view-content {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            padding: 20px;
        }

        .playlist-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .playlist-col h4 {
            color: var(--accent-color);
            margin: 0 0 15px 0;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
        }

        .playlist-col>div {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .playlist-col>div::-webkit-scrollbar {
            width: 6px;
        }

        .playlist-col>div::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .playlist-col>div::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .playlist-view-content {
                flex-direction: column;
            }

            .playlist-col {
                max-height: 40vh;
            }
        }

        /* 播放列表视图模态框样式 */
        .playlist-view-container {
            background: rgba(20, 20, 30, 0.98);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .playlist-view-content {
            display: flex;
            gap: 20px;
            flex: 1;
            overflow: hidden;
            padding: 20px;
        }

        .playlist-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .playlist-col h4 {
            color: rgb(0, 210, 106);
            margin: 0 0 15px 0;
            font-size: 1.1em;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .playlist-col>div {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }

        .playlist-col>div::-webkit-scrollbar {
            width: 6px;
        }

        .playlist-col>div::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .playlist-col>div::-webkit-scrollbar-thumb {
            background: rgb(0, 210, 106);
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .playlist-view-container {
                width: 95% !important;
                max-height: 90vh !important;
            }

            .playlist-view-content {
                flex-direction: column !important;
                padding: 15px !important;
                gap: 15px !important;
            }

            .playlist-col {
                max-height: 35vh !important;
            }

            .playlist-col h4 {
                font-size: 1em !important;
            }
        }

        /* 联系链接样式 */
        .contact-link {
            color: #4dabf7;
            text-decoration: none;
            transition: color 0.3s;
        }

        .contact-link:hover {
            color: #74c0fc;
            text-decoration: underline;
        }

        /* 危险按钮样式 */
        .danger-btn {
            background-color: rgba(255, 59, 48, 0.8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .danger-btn:hover {
            background-color: rgba(255, 59, 48, 1);
        }

        .info-message {
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.8);
        }

        .info-message p {
            margin: 0;
            line-height: 1.5;
        }

        /* 减少动画效果的样式 */
        .reduce-animations * {
            animation-duration: 0.1s !important;
            transition-duration: 0.1s !important;
        }

        /* 触控按钮大小样式 */
        .touch-small {
            padding: 8px 12px !important;
            font-size: 12px !important;
            min-width: 60px !important;
        }

        .touch-medium {
            padding: 10px 16px !important;
            font-size: 14px !important;
            min-width: 80px !important;
        }

        .touch-large {
            padding: 14px 20px !important;
            font-size: 16px !important;
            min-width: 100px !important;
        }


        /* ============== 其他组件样式 (保留并优化) ============== */
        .delete-font-btn,
        .delete-bg-btn {
            background-color: rgba(255, 59, 48, 0.8);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .delete-font-btn:hover,
        .delete-bg-btn:hover {
            background-color: #ff3b30;
        }

        .delete-font-btn:disabled {
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
        }

        .password-form-container {
            position: relative;
        }

        #password-input {
            width: 100%;
            box-sizing: border-box;
            padding: 12px 45px 12px 15px;
            text-align: left;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        #toggle-password-visibility {
            position: absolute;
            top: 50%;
            right: 15px;
            transform: translateY(-85%);
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
            color: var(--text-secondary);
        }

        #toggle-password-visibility:hover {
            color: var(--text-main);
        }

        #toggle-password-visibility svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        #password-submit-btn {
            width: 100%;
            padding: 12px;
            font-size: 1.1em;
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .hint-text {
            font-size: 0.85em;
            color: var(--text-secondary);
            margin-top: -5px;
            display: block;
        }

        #video-list-container {
            max-height: 250px;
            overflow-y: auto;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .video-list-item-url {
            flex-grow: 1;
            margin-right: 10px;
            font-size: 0.9em;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .status-label {
            font-size: 0.8em;
            margin-left: 8px;
            font-weight: bold;
            flex-shrink: 0;
        }

        .invalid-label {
            color: #ff6b6b;
        }

        .checking-label {
            color: #f0ad4e;
        }

        .user-label {
            color: var(--accent-color);
        }

        .video-item-actions button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            margin-left: 5px;
            padding: 5px;
            transition: color 0.2s;
        }

        .video-item-actions button:hover {
            color: var(--text-main);
        }

        #play-mode-controls,
        .screensaver-controls {
            display: flex;
            gap: 10px;
            justify-content: flex-start;
            flex-wrap: wrap;
        }

        .play-mode-btn,
        .screensaver-btn {
            padding: 8px 15px;
            background-color: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.2s;
        }

        .play-mode-btn:hover,
        .screensaver-btn:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-main);
        }

        .play-mode-btn.active,
        .screensaver-btn.active {
            background-color: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
            font-weight: 600;
        }

        .video-preview-container {
            width: 80vw;
            max-width: 900px;
            background-color: #000;
            padding: 10px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            position: relative;
            border: 1px solid var(--glass-border);
        }

        #video-preview-player {
            width: 100%;
            height: auto;
            border-radius: var(--radius-sm);
            max-height: 80vh;
        }

        #close-video-preview {
            top: -15px;
            right: -15px;
            background: #2c2c2c;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5em;
            position: absolute;
            cursor: pointer;
            border: 1px solid var(--glass-border);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .playlist-item,
        .song-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid transparent;
        }

        .playlist-item:hover,
        .song-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .playlist-item.active-item,
        .song-item.active-item {
            background-color: rgba(0, 210, 106, 0.1);
            color: var(--accent-color);
            border-color: rgba(0, 210, 106, 0.3);
            font-weight: 600;
        }

        .playlist-item-name {
            font-size: 0.95em;
        }

        .song-item-index {
            margin-right: 10px;
            color: var(--text-secondary);
            width: 20px;
            text-align: right;
            font-size: 0.85em;
        }

        .song-item-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .song-item-name {
            font-size: 0.95em;
            font-weight: 500;
            text-align: left;
            color: var(--text-main);
        }

        .song-item-artist {
            font-size: 0.85em;
            color: var(--text-secondary);
            text-align: right;
        }

        @media (max-width: 480px) {
            .song-item-meta {
                gap: 6px;
            }

            .song-item-name,
            .song-item-artist {
                min-width: 0;
                max-width: 48%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        .playlist-view-container {
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            background-color: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            flex-direction: column;
            position: relative;
            border: 1px solid var(--glass-border);
        }

        .playlist-view-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-height: 0;
            padding: 0 20px 20px 20px;
            gap: 10px;
        }

        .playlist-col {
            display: flex;
            flex-direction: column;
            padding: 10px;
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-sm);
            height: auto;
            flex: 1;
            min-height: 0;
            background: rgba(0, 0, 0, 0.2);
        }

        .playlist-col:first-child {
            margin-bottom: 15px;
        }

        .playlist-col h4 {
            margin-top: 0;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--glass-border);
            text-align: center;
            font-size: 1.1em;
            color: var(--accent-color);
        }

        #modal-album-list,
        #modal-song-list {
            flex: 1;
            overflow-y: auto;
        }
    </style>
</head>

<body>

    <div id="bg-container">
        <video id="bg-video" autoplay muted playsinline webkit-playsinline x5-playsinline x5-video-player-type="h5"
            x5-video-player-fullscreen="false"></video>
    </div>
    <div id="content-overlay"></div>

    <div class="main-container">
        <div id="lyricsDisplay">
            <div class="lyric-line-top">
                <span class="lyric-part lyric-top-part" id="lyric-top-p1">(加载中...)</span>
                <span id="lyric-top-separator">&middot;</span>
                <span class="lyric-part lyric-top-part" id="lyric-top-p2"></span>
            </div>
            <div class="lyric-line-bottom">
                <span id="lyric-placeholder"></span>
                <span id="lyric-bottom-separator"></span>
                <span class="lyric-part" id="lyric-bottom-part"></span>
            </div>
        </div>
    </div>

    <div id="time-screensaver">
        <div id="time-display"></div>
        <div id="date-display"></div>
    </div>

    <div id="songInfoDisplay">歌曲信息加载中...</div>
    <div id="toast-notification" class="toast-notification"></div>
    <div id="volume-bar-container" class="volume-bar-container">
        <div id="volume-level-text">音量: 50%</div>
        <div class="volume-bar-inner">
            <div id="volume-bar-fill" class="volume-bar-fill"></div>
        </div>
    </div>

    <div id="settings-hot-zone">
        <div id="settings-button" title="设置">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path
                    d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z" />
            </svg>
        </div>
    </div>

    <div id="settings-panel">
        <div class="settings-container">
            <div class="settings-sidebar">
                <div class="sidebar-header">
                    <i class="fas fa-cog"></i> 设置
                </div>
                <button class="sidebar-nav-btn active" data-tab="tab-player">
                    <i class="fas fa-music"></i> 播放器
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-appearance">
                    <i class="fas fa-paint-brush"></i> 外观
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-screensaver">
                    <i class="fas fa-clock"></i> 时间屏保
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-background">
                    <i class="fas fa-image"></i> 背景
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-playlist">
                    <i class="fas fa-list"></i> 播放列表
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-advanced">
                    <i class="fas fa-sliders-h"></i> 高级
                </button>
                <button class="sidebar-nav-btn" data-tab="tab-about">
                    <i class="fas fa-info-circle"></i> 关于
                </button>
            </div>

            <div class="settings-main-content">
                <!-- 移动端顶部导航栏 -->
                <div class="mobile-tab-bar">
                    <button class="mobile-tab-btn active" data-tab="tab-player">播放器</button>
                    <button class="mobile-tab-btn" data-tab="tab-appearance">外观</button>
                    <button class="mobile-tab-btn" data-tab="tab-screensaver">屏保</button>
                    <button class="mobile-tab-btn" data-tab="tab-background">背景</button>
                    <button class="mobile-tab-btn" data-tab="tab-playlist">列表</button>
                    <button class="mobile-tab-btn" data-tab="tab-advanced">高级</button>
                    <button class="mobile-tab-btn" data-tab="tab-about">关于</button>
                </div>

                <div class="settings-header">
                    <h2 style="margin:0; font-size:1.5em; color:var(--text-main);">设置</h2>
                    <button id="close-settings" class="modal-close-btn" title="关闭">&times;</button>
                </div>
                <div class="settings-content">
                    <!-- 播放器设置 (UI美化) -->
                    <div id="tab-player" class="tab-content active">
                        <div class="settings-section">
                            <h4>播放进度</h4>
                            <div class="progress-container">
                                <div id="current-time">0:00</div>
                                <div id="progress-bar" class="progressbg" title="拖动以调整进度">
                                    <div id="progress-bar-fill" class="progressbg1"></div>
                                    <div id="progress-bar-buffer" class="progressbg2"></div>
                                    <div id="progress-bar-handle" class="ts"></div>
                                </div>
                                <div id="total-time">0:00</div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>播放器控制</h4>
                            <div id="player-controls">
                                <button id="prev-btn" class="control-btn" title="上一曲 (←)">
                                    <i class="fas fa-step-backward"></i>
                                </button>
                                <button id="play-pause-btn" class="control-btn play" title="播放/暂停 (Space)">
                                    <i class="fas fa-play"></i>
                                </button>
                                <button id="playback-speed-btn" class="control-btn" title="播放速度">1.0x</button>
                                <button id="next-btn" class="control-btn" title="下一曲 (→)">
                                    <i class="fas fa-step-forward"></i>
                                </button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>播放模式</h4>
                            <div id="play-mode-controls">
                                <button class="play-mode-btn" data-mode="0">专辑循环</button>
                                <button class="play-mode-btn" data-mode="1">单曲循环</button>
                                <button class="play-mode-btn" data-mode="2">随机播放</button>
                            </div>
                        </div>

                        <div class="settings-section" id="view-playlist-btn-container" style="display: none;">
                            <h4>播放列表</h4>
                            <button id="view-playlist-btn">查看并切换播放列表</button>
                        </div>
                    </div>

                    <!-- 外观设置 (UI美化) -->
                    <div id="tab-appearance" class="tab-content">
                        <div class="settings-section">
                            <h4>歌词动画</h4>
                            <div class="form-group">
                                <label for="lyric-animation-select">动画风格</label>
                                <select id="lyric-animation-select">
                                    <option value="subtle">微妙 (原始)</option>
                                    <option value="dynamic">动态 (推荐)</option>
                                </select>
                                <button id="reset-lyric-anim">重置</button>
                            </div>
                        </div>
                        <div class="settings-section">
                            <h4>字体设置</h4>
                            <h5>中文字体</h5>
                            <div class="form-group">
                                <select id="chinese-font-select"></select>
                                <button id="delete-chinese-font-btn" class="delete-font-btn"
                                    title="删除选中的自定义字体">删除</button>
                            </div>
                            <div class="form-group vertical">
                                <input type="text" id="new-chinese-font-name" placeholder="新字体名称 (例如: 思源宋体)">
                            </div>
                            <div class="form-group vertical">
                                <textarea id="new-chinese-font-embed"
                                    placeholder="粘贴字体的嵌入代码 (例如 <link ...> 或 @import)"></textarea>
                            </div>
                            <div class="form-group">
                                <button id="add-chinese-font-btn">添加中文字体</button>
                            </div>
                            <hr style="border-color: #444; margin: 20px 0;">

                            <h5>英文字体</h5>
                            <div class="form-group">
                                <select id="english-font-select"></select>
                                <button id="delete-english-font-btn" class="delete-font-btn"
                                    title="删除选中的自定义字体">删除</button>
                            </div>
                            <div class="form-group vertical">
                                <input type="text" id="new-english-font-name" placeholder="New Font Name (e.g., Inter)">
                            </div>
                            <div class="form-group vertical">
                                <textarea id="new-english-font-embed"
                                    placeholder="Paste font embed code (e.g. <link ...> or @import)"></textarea>
                            </div>
                            <div class="form-group">
                                <button id="add-english-font-btn">添加英文字体</button>
                            </div>
                        </div>
                    </div>

                    <!-- 新的时间屏保标签页 (包含完整内容) -->
                    <div id="tab-screensaver" class="tab-content">
                        <div class="settings-section">
                            <h4>时间屏保</h4>
                            <div class="form-group">
                                <label for="screensaver-toggle">启用时间屏保</label>
                                <label class="switch">
                                    <input type="checkbox" id="screensaver-toggle">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label>显示模式</label>
                                <div class="screensaver-controls">
                                    <button class="screensaver-btn" data-mode="always">始终常驻</button>
                                    <button class="screensaver-btn" data-mode="onpause">音乐暂停时</button>
                                </div>
                            </div>
                            <div class="form-group grid-2">
                                <select id="screensaver-style-select">
                                    <option value="modern">现代风格</option>
                                    <option value="ancient">中国古代</option>
                                    <option value="western">西方风格</option>
                                </select>
                                <select id="screensaver-date-style-select">
                                    <option value="YYYY-MM-DD">2024-07-18</option>
                                    <option value="MM-DD-YYYY">07-18-2024</option>
                                    <option value="full">2024年7月18日 星期四</option>
                                </select>
                            </div>
                            <div class="form-group grid-2">
                                <div class="form-group">
                                    <label for="ss-show-seconds">精确到秒</label>
                                    <label class="switch">
                                        <input type="checkbox" id="ss-show-seconds">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="ss-show-lunar">显示农历</label>
                                    <label class="switch">
                                        <input type="checkbox" id="ss-show-lunar">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="ss-show-date">显示日期</label>
                                    <label class="switch">
                                        <input type="checkbox" id="ss-show-date">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="ss-use-custom-font">应用字体</label>
                                    <label class="switch">
                                        <input type="checkbox" id="ss-use-custom-font">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="ss-font-size">字号</label>
                                <input type="range" id="ss-font-size" min="3" max="20" value="10">
                                <span id="ss-font-size-value">10vw</span>
                            </div>
                            <div class="form-group">
                                <button id="reset-screensaver">恢复默认</button>
                            </div>
                        </div>
                    </div>

                    <!-- 背景设置 (完全重构) -->
                    <div id="tab-background" class="tab-content">
                        <div class="settings-section">
                            <h4>轮播模式</h4>
                            <div class="form-group">
                                <select id="bg-playback-mode">
                                    <option value="comprehensive">综合模式 (播放所有勾选的)</option>
                                    <option value="gist">仅网络视频 (Gist/URL)</option>
                                    <option value="image">仅图片轮播 (本地/URL)</option>
                                    <option value="local_video">仅本地视频</option>
                                </select>
                            </div>
                        </div>

                        <!-- 新的背景源管理 -->
                        <div class="settings-section">
                            <h4>内容源管理</h4>
                            <div class="form-group vertical">
                                <h5>网络视频 (Gist / URL)</h5>
                                <div class="form-group">
                                    <input type="url" id="gist-url-input" placeholder="粘贴 Gist Raw 链接...">
                                    <button id="load-from-gist-btn">加载</button>
                                </div>
                                <div class="form-group">
                                    <input type="url" id="new-video-url" placeholder="粘贴视频网址(多个链接请用换行分隔)...">
                                    <button id="add-manually-video-btn">添加</button>
                                </div>
                            </div>
                            <hr style="border-color: #444; margin: 20px 0;">
                            <div class="form-group vertical">
                                <h5>图片轮播 (本地 / URL)</h5>
                                <div class="form-group">
                                    <label for="upload-images" class="custom-file-upload">上传图片 (可多选)</label>
                                    <!-- 允许一次性上传多个 -->
                                    <input type="file" id="upload-images" accept="image/*" multiple>
                                </div>
                                <div class="form-group">
                                    <input type="url" id="new-image-url" placeholder="粘贴图片网址(多个链接请用换行分隔)...">
                                    <button id="add-image-url-btn">添加</button>
                                </div>
                            </div>
                            <hr style="border-color: #444; margin: 20px 0;">
                            <div class="form-group vertical">
                                <h5>本地视频 (本地上传)</h5>
                                <div class="form-group">
                                    <label for="upload-local-videos" class="custom-file-upload">上传本地视频 (可多选)</label>
                                    <!-- 允许一次性上传多个 -->
                                    <input type="file" id="upload-local-videos" accept="video/*" multiple>
                                </div>
                            </div>
                            <hr style="border-color: #444; margin: 20px 0;">
                            <div class="form-group vertical">
                                <h5>剪贴板</h5>
                                <div class="form-group">
                                    <button id="paste-from-clipboard-btn">从剪贴板粘贴 (图片/URL)</button>
                                </div>
                                <small class="hint-text">提示：支持粘贴截图、图片文件、或一行一个的URL文本。</small>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>选项</h4>
                            <div class="form-group grid-2">
                                <div class="form-group">
                                    <label for="bg-image-animation">图片缩放动画</label>
                                    <label class="switch">
                                        <input type="checkbox" id="bg-image-animation">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                                <div class="form-group">
                                    <label for="content-highlight">内容突出显示</label>
                                    <label class="switch">
                                        <input type="checkbox" id="content-highlight">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                            </div>
                            <!-- 核心修改：将 select 替换为 input type=number -->
                            <div class="form-group" style="align-items: center;">
                                <label for="bg-change-interval">图片切换间隔</label>
                                <input type="number" id="bg-change-interval" min="0" value="30"
                                    style="width: 80px; text-align: center;">
                                <span style="margin-left: 8px;">秒</span>
                                <button id="reset-bg-change-interval" style="margin-left:8px;">重置</button>
                            </div>
                            <small class="hint-text" style="margin-top: -5px; margin-bottom: 10px;">提示：设为 0 表示图片不自动轮播
                                (视频仍会在结束后切换)。</small>
                            <div class="form-group" id="overlay-opacity-container" style="display: none;">
                                <label for="overlay-opacity">蒙版不透明度</label>
                                <input type="range" id="overlay-opacity" min="10" max="80" value="50">
                                <span id="overlay-opacity-value">50%</span>
                            </div>
                        </div>

                        <div class="settings-section">
                            <div class="list-header">
                                <h4>背景列表 <span id="video-count"></span></h4>
                                <div>
                                    <button id="select-all-bg-btn">全选</button>
                                    <button id="select-all-images-btn">全选图片</button>
                                    <button id="select-all-videos-btn">全选视频</button>
                                    <button id="deselect-all-bg-btn">全不选</button>
                                    <button id="copy-playlist-btn" title="复制当前列表到剪贴板">复制列表</button>
                                </div>
                            </div>
                            <small class="hint-text">提示：勾选的项目才会参与“综合模式”轮播。列表将自动保存。</small>
                            <div id="video-list-container">
                                <!-- Video list will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>

                    <!-- 高级设置 (UI美化) -->
                    <div id="tab-advanced" class="tab-content">
                        <div class="settings-section">
                            <h4>性能设置</h4>
                            <div class="form-group">
                                <label for="enable-wake-lock">保持屏幕常亮</label>
                                <label class="switch">
                                    <input type="checkbox" id="enable-wake-lock" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="reduce-animations">减少动画效果</label>
                                <label class="switch">
                                    <input type="checkbox" id="reduce-animations">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="video-quality">视频质量</label>
                                <select id="video-quality">
                                    <option value="high">高质量</option>
                                    <option value="medium" selected>中等</option>
                                    <option value="low">低质量</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>移动端优化</h4>
                            <div class="form-group">
                                <label for="mobile-data-saver">数据节省模式</label>
                                <label class="switch">
                                    <input type="checkbox" id="mobile-data-saver">
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label for="touch-controls-size">触控按钮大小</label>
                                <select id="touch-controls-size">
                                    <option value="small">小</option>
                                    <option value="medium" selected>中</option>
                                    <option value="large">大</option>
                                </select>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>显示选项</h4>
                            <div class="form-group">
                                <button id="fullscreen-btn">全屏模式</button>
                                <div class="setting-description">点击进入/退出全屏模式，类似视频全屏效果</div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>数据管理</h4>
                            <div class="form-group">
                                <button id="export-settings-btn">导出设置</button>
                                <button id="import-settings-btn">导入设置</button>
                            </div>
                            <div class="form-group">
                                <button id="clear-cache-btn" class="danger-btn">清除缓存</button>
                                <button id="reset-settings-btn" class="danger-btn">重置所有设置</button>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>本地音乐</h4>
                            <div class="form-group">
                                <label for="load-local-audio" class="custom-file-upload">加载本地文件 (音频)</label>
                                <input type="file" id="load-local-audio" accept="audio/*,.mp3,.m4a,.aac,.wav,.ogg,.flac"
                                    multiple>
                                <button id="clear-local-audio">清空本地音乐</button>
                            </div>
                            <div class="form-group">
                                <label for="load-local-folder" class="custom-file-upload">加载本地文件夹</label>
                                <input type="file" id="load-local-folder" accept="audio/*" webkitdirectory>
                            </div>
                            <small class="hint-text">提示：浏览器出于安全限制无法读取本地文件内嵌的歌词与封面。</small>
                        </div>
                    </div>

                    <!-- 播放列表 Tab -->
                    <div id="tab-playlist" class="tab-content">
                        <div class="settings-section">
                            <h4>播放列表</h4>
                            <div class="form-group" style="margin-bottom: 15px;">
                                <input type="search" id="settings-playlist-search" placeholder="搜索专辑或曲目..."
                                    style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.3); color: white;">
                            </div>
                            <!-- 使用inline样式的两列布局 -->
                            <div
                                style="display: flex; flex-direction: row; gap: 15px; min-height: 400px; max-height: 60vh;">
                                <!-- 左列：专辑列表 -->
                                <div
                                    style="flex: 1; display: flex; flex-direction: column; min-width: 0; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                                    <h5
                                        style="color: rgb(0, 210, 106); margin: 0 0 10px 0; font-size: 1em; padding-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                                        所有专辑</h5>
                                    <div id="settings-album-list"
                                        style="flex: 1; overflow-y: auto; padding-right: 5px;"></div>
                                </div>
                                <!-- 右列：歌曲列表(更宽) -->
                                <div
                                    style="flex: 2; display: flex; flex-direction: column; min-width: 0; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 15px; border: 1px solid rgba(255,255,255,0.05);">
                                    <h5
                                        style="color: rgb(0, 210, 106); margin: 0 0 10px 0; font-size: 1em; padding-bottom: 8px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                                        当前播放</h5>
                                    <div id="settings-song-list" style="flex: 1; overflow-y: auto; padding-right: 5px;">
                                    </div>
                                </div>
                            </div>
                            <style>
                                /* 移动端播放列表响应式 */
                                @media (max-width: 768px) {
                                    #tab-playlist>.settings-section>div[style*="flex-direction: row"] {
                                        flex-direction: column !important;
                                        max-height: none !important;
                                    }

                                    #tab-playlist>.settings-section>div[style*="flex-direction: row"]>div {
                                        max-height: 30vh !important;
                                    }
                                }
                            </style>
                        </div>
                    </div>

                    <!-- 关于 (UI美化) -->
                    <div id="tab-about" class="tab-content">
                        <div class="settings-section">
                            <h4>关于播放器</h4>
                            <p>音乐视频播放器 v1.9.11</p>
                            <p>基于 HTML5 和 JavaScript 开发的现代化音乐播放器</p>
                            <p>支持背景视频、歌词显示、播放列表管理等功能</p>
                        </div>

                        <div class="settings-section">
                            <h4>快捷键</h4>
                            <div class="shortcut-list">
                                <div class="shortcut-item">
                                    <span class="key">空格</span>
                                    <span class="description">播放/暂停</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">←</span>
                                    <span class="description">上一曲</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">→</span>
                                    <span class="description">下一曲</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">↑</span>
                                    <span class="description">增加音量</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">↓</span>
                                    <span class="description">减小音量</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">M</span>
                                    <span class="description">静音/取消静音</span>
                                </div>
                                <div class="shortcut-item">
                                    <span class="key">S</span>
                                    <span class="description">打开设置</span>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h4>联系与反馈</h4>
                            <p>如有问题或建议，请通过以下方式联系：</p>
                            <p><a href="mailto:coren2025@outlook.com" class="contact-link">coren2025@outlook.com</a></p>
                            <!-- [修复] 添加 target="_blank" -->
                            <p>Hi！there is Coren:<a href="https://coren.xin" target="_blank"
                                    class="contact-link">coren.xin</a></p>
                            <!-- [修复] 新增：版权信息 -->
                            <p style="margin-top: 15px; font-size: 0.9em; color: #aaa;">
                                版权所有 © 2024 <a href="https://coren.xin" target="_blank" class="contact-link">Coren</a>.
                            </p>网站内置默认视频来自“影视飓风（ysjf.com）”样片日记。
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- [修复] 注释掉密码模态框 -->
    <!--
    <div id="password-modal">
        <div class="modal-container">
            <h3 class="modal-header">请输入密码</h3>
            <button id="close-password-modal" class="modal-close-btn" title="关闭">&times;</button>
            <form id="password-form">
                <div class="password-form-container">
                    <input type="password" id="password-input" placeholder="密码">
                    <button type="button" id="toggle-password-visibility" title="显示/隐藏密码">
                        <svg id="eye-open" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                        <svg id="eye-closed" style="display: none;" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.83l2.92 2.92c1.51-1.26 2.7-2.89 3.43-4.75-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L21.73 23 23 21.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.16c0-1.66-1.34-3-3-3l-.17.01z"/></svg>
                    </button>
                </div>
                <button type="submit" id="password-submit-btn" class="form-group-button">确认</button>
            </form>
        </div>
    </div>
    -->

    <div id="video-preview-modal">
        <div class="video-preview-container">
            <video id="video-preview-player" controls autoplay playsinline></video>
            <button id="close-video-preview" class="modal-close-btn" title="关闭预览">&times;</button>
        </div>
    </div>

    <div id="custom-context-menu" class="context-menu"></div>

    <div id="playlist-view-modal">
        <div class="playlist-view-container">
            <div class="settings-header">
                <h2>播放列表</h2>
                <button id="close-playlist-view" class="modal-close-btn" title="关闭">&times;</button>
            </div>
            <div class="form-group" style="margin:10px 20px;">
                <input type="search" id="playlist-search" placeholder="搜索专辑或曲目...">
            </div>
            <!-- 重要！使用 inline style 强制左右布局，移动端自适应 -->
            <div
                style="display: flex; flex-direction: row; gap: 20px; flex: 1; overflow: hidden; padding: 20px; min-height: 0;">
                <!-- 左列：所有专辑 (桌面端较窄) -->
                <div style="flex: 1; display: flex; flex-direction: column; min-width: 0; overflow: hidden;">
                    <h4
                        style="color: rgb(0, 210, 106); margin: 0 0 15px 0; font-size: 1.1em; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                        所有专辑</h4>
                    <div id="modal-album-list" style="flex: 1; overflow-y: auto; padding-right: 5px;"></div>
                </div>
                <!-- 右列：当前播放 (桌面端更宽，显示更多歌曲信息) -->
                <div style="flex: 2; display: flex; flex-direction: column; min-width: 0; overflow: hidden;">
                    <h4
                        style="color: rgb(0, 210, 106); margin: 0 0 15px 0; font-size: 1.1em; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                        当前播放</h4>
                    <div id="modal-song-list" style="flex: 1; overflow-y: auto; padding-right: 5px;"></div>
                </div>
            </div>
        </div>
    </div>

    <!--// 模块一结束 -->

    <script type="text/javascript" id="myhk" src="https://myhkw.cn/api/player/1746320559107" key="1746320559107"
        m="1"></script>

    <script>
        // *** 核心修复：注册 Service Worker 以启用PWA安装功能 ***
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => {
                        console.log('ServiceWorker Registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker Registration failed: ', err);
                    });
            });
        }

        // 解决移动端背景视频和音乐播放互相干扰的问题
        document.addEventListener('DOMContentLoaded', function () {
            const videoElement = document.getElementById('bg-video');

            // 强制设置视频属性
            videoElement.setAttribute('playsinline', '');
            videoElement.setAttribute('webkit-playsinline', '');
            videoElement.setAttribute('x5-playsinline', '');
            videoElement.setAttribute('x5-video-player-type', 'h5');
            videoElement.setAttribute('x5-video-player-fullscreen', 'false');
            videoElement.muted = true;
            videoElement.autoplay = true;
            videoElement.loop = false; // 修复问题1：禁用原生循环

            // 解决移动端音频上下文未激活问题
            let audioContext;
            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioContext = new AudioContext();
                const resumeAudioContext = () => {
                    if (audioContext.state === 'suspended') {
                        audioContext.resume();
                    }
                    document.removeEventListener('click', resumeAudioContext);
                    document.removeEventListener('touchstart', resumeAudioContext);
                };
                document.addEventListener('click', resumeAudioContext);
                document.addEventListener('touchstart', resumeAudioContext);
            } catch (e) {
                console.error('无法创建AudioContext:', e);
            }

            // 强制保持视频播放的函数
            function forcePlayVideo() {
                if (videoElement.paused) {
                    const playPromise = videoElement.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            if (error.name !== 'NotAllowedError') {
                                console.error('背景视频播放失败:', error);
                            }
                        });
                    }
                }
            }

            // 定期检查，作为最后的保障措施 (优化：延长检查间隔至5秒)
            setInterval(forcePlayVideo, 5000);

            // 页面从后台切换回前台时，确保视频在播放
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    forcePlayVideo();
                }
            });

            // 修复问题2：更精确地监听音乐播放事件
            // 使用 MutationObserver 等待 myhkaudio 播放器对象加载完成
            const observer = new MutationObserver((mutations, obs) => {
                if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                    // 找到播放器对象后，监听其播放事件
                    myhkaudio.addEventListener('play', () => {
                        console.log('检测到音乐播放，确保背景视频继续运行。');
                        forcePlayVideo();
                    });
                    obs.disconnect(); // 任务完成，停止观察
                }
            });
            observer.observe(document.body, { childList: true, subtree: true });

            // 页面加载后立即尝试播放
            forcePlayVideo();
        });


        $(document).ready(function () {
            let playerMonitorInterval; let songInfoLoaded = false; let initPlayerRetries = 0;
            // --- 新增: 背景管理键名 ---
            const BG_LIST_KEY = 'customBackgroundList_v2'; // 新的列表键
            const BG_ENABLED_MAP_KEY = 'customBackgroundEnabledMap'; // 记忆勾选状态
            const BG_PLAYBACK_MODE_KEY = 'customBackgroundPlaybackMode'; // 记忆播放模式
            const videoListContainer = $('#video-list-container');
            const videoCountSpan = $('#video-count');
            // --- 结束新增 ---
            const MAX_INIT_RETRIES = 25; const RETRY_DELAY = 1500;
            const lyricsContainer = $('#lyricsDisplay');
            let noLyricTimer = null;

            const PLAY_MODE_KEY = 'musicPlayerPlayMode';
            const PLAY_MODES = {
                ALBUM_LOOP: { id: 0, text: '专辑循环', iconClass: 'myhkicon-liebiao_xunhuan' },
                SINGLE_LOOP: { id: 1, text: '单曲循环', iconClass: 'myhkicon-danquxunhuan' },
                RANDOM: { id: 2, text: '随机播放', iconClass: 'myhkicon-suijibofang' }
            };
            const PLAY_MODE_ORDER = [PLAY_MODES.ALBUM_LOOP, PLAY_MODES.SINGLE_LOOP, PLAY_MODES.RANDOM];
            let currentPlayMode = PLAY_MODES.ALBUM_LOOP.id;

            // [修复] 新增：用于处理页面可见性API的变量
            let backgroundChangeTimer = null;
            let timerStartTime = 0;
            let timerRemaining = 0;

            // [修复] 新增：用于修复时间屏保切歌bug的标志
            let isChangingTrack = false;


            const wordBank = [
                "义无反顾", "奋不顾身", "一见钟情", "天长地久", "海阔天空", "无所谓",
                "我爱你", "对不起", "没关系", "为什么", "怎么样", "一下子", "我听见", "看不见",
                "如果", "我们", "世界", "天空", "风雨", "阳光", "心中", "自由", "梦想",
                "青春", "回忆", "温柔", "等候", "再见", "你好", "晚安", "明天", "昨天",
                "今天", "未来", "曾经", "拥有", "再也", "只是", "终于", "还是", "那么", "你们",
                "他们", "大家", "所有"
            ];

            function getTextUnitCount(str) {
                if (typeof str !== 'string' || !str) return 0;
                const s = str.trim();
                if (/[a-zA-Z]/.test(s)) {
                    return s.split(/\s+/).filter(Boolean).length;
                }
                return s.length;
            }

            function splitChineseLyric(text) {
                if (text.length <= 1) {
                    return [text, ''];
                }

                const rand = Math.random();
                let splitIndex;

                if (text.length > 1 && rand < 0.45) {
                    splitIndex = 1;
                } else if (text.length > 2 && rand < 0.90) {
                    splitIndex = 2;
                } else {
                    for (const word of wordBank) {
                        if (text.startsWith(word) && (word.length === 3 || word.length === 4)) {
                            return [word, text.substring(word.length)];
                        }
                    }
                    splitIndex = text.length > 2 ? 2 : 1;
                }

                if (splitIndex >= text.length) {
                    splitIndex = 1;
                }

                return [text.substring(0, splitIndex), text.substring(splitIndex)];
            }

            function splitEnglishLyric(text, topWordLimit) {
                const words = text.split(/\s+/).filter(Boolean);
                const topWords = words.slice(0, topWordLimit);
                const bottomWords = words.slice(topWordLimit);

                const p1 = topWords.slice(0, 1).join(' ');
                const p2 = topWords.slice(1).join(' ');

                return [p1, p2, bottomWords.join(' ')];
            }

            let wakeLock = null;
            const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) { console.error(`Wake Lock Error: ${err.name}, ${err.message}`); } };
            const releaseWakeLock = async () => { if (wakeLock) await wakeLock.release(); wakeLock = null; };
            document.addEventListener('visibilitychange', () => { if (wakeLock === null && document.visibilityState === 'visible' && typeof myhkaudio !== 'undefined' && !myhkaudio.paused) requestWakeLock(); });

            // 辅助函数：将文本分割为中文和英文，并用span标签包装
            function wrapTextWithFontSpans(text) {
                if (!text) return '';

                // 使用正则表达式匹配中文字符和非中文字符
                // 中文字符范围：\u4e00-\u9fff (基本汉字)
                // 还包括：\u3400-\u4dbf (扩展A), \u20000-\u2a6df (扩展B), \u2a700-\u2b73f (扩展C), \u2b740-\u2b81f (扩展D)
                // 以及一些中文标点符号等
                return text.replace(/([\u4e00-\u9fff\u3400-\u4dbf\u3000-\u303f]+)|([^\u4e00-\u9fff\u3400-\u4dbf\u3000-\u303f]+)/g, function (match, chinese, english) {
                    if (chinese) {
                        return '<span class="chinese-char">' + chinese + '</span>';
                    } else if (english) {
                        return '<span class="english-char">' + english + '</span>';
                    }
                    return match; // 不应该到达这里
                });
            }

            function renderLyric(text) {
                const topP1El = $('#lyric-top-p1');
                const topP2El = $('#lyric-top-p2');
                const topSeparatorEl = $('#lyric-top-separator');
                const bottomPartEl = $('#lyric-bottom-part');
                const placeholderEl = $('#lyric-placeholder');
                const bottomSeparatorEl = $('#lyric-bottom-separator');

                clearTimeout(noLyricTimer);
                const isStatusMessage = text.startsWith('(') && text.endsWith(')');
                const isEnglish = /[a-zA-Z]/.test(text);

                // 保留这个类，用于其他样式目的，但不再用于字体切换
                lyricsContainer.toggleClass('english-lyric', isEnglish);

                if (isStatusMessage) {
                    topP1El.html(wrapTextWithFontSpans(text)).removeClass('larger');
                    topP2El.html('').removeClass('larger');
                    bottomPartEl.html('');
                    placeholderEl.text('');
                    topSeparatorEl.hide();
                    bottomSeparatorEl.text('');

                    if (text === "ヾ(≧▽≦*)o") {
                        noLyricTimer = setTimeout(() => {
                            if ($('#lyric-top-p1').text() === "ヾ(≧▽≦*)o") {
                                renderLyric('');
                            }
                        }, 10000);
                    }
                    return;
                }

                let p1 = "", p2 = "", bottomText = "";

                if (isEnglish) {
                    [p1, p2, bottomText] = splitEnglishLyric(text, 3);
                } else {
                    const mainSplitIndex = Math.min(5, text.length);
                    const topText = text.substring(0, mainSplitIndex).trim();
                    bottomText = text.substring(mainSplitIndex).trim();
                    [p1, p2] = splitChineseLyric(topText);
                }

                // 使用html()方法而不是text()，以便应用带有span标签的内容
                topP1El.html(wrapTextWithFontSpans(p1.trim()));
                topP2El.html(wrapTextWithFontSpans(p2.trim()));
                bottomPartEl.html(wrapTextWithFontSpans(bottomText));

                if (bottomText || p1) {
                    placeholderEl.text('HELLO COREN.XIN');
                    bottomSeparatorEl.text('|');
                } else {
                    placeholderEl.text('');
                    bottomSeparatorEl.text('');
                }

                if (p2.trim()) {
                    topSeparatorEl.show();
                } else {
                    topSeparatorEl.hide();
                }

                topP1El.removeClass('larger');
                topP2El.removeClass('larger');
                if (p1 && p2) {
                    if (getTextUnitCount(p1) < getTextUnitCount(p2)) {
                        topP1El.addClass('larger');
                    } else if (getTextUnitCount(p2) < getTextUnitCount(p1)) {
                        topP2El.addClass('larger');
                    }
                }
            }

            function turnOffPlayerInternalLyrics() {
                const lyricSwitch = $('.switch-ksclrc');
                if (lyricSwitch.length > 0 && lyricSwitch.find('i').hasClass('myhkicon-anniu_kaiqi')) {
                    lyricSwitch.trigger('click');
                }
            }

            function updateMediaSession(title, artist, artworkSrc) {
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata({
                        title: title,
                        artist: artist,
                        album: 'Music Video Player',
                        artwork: [
                            { src: artworkSrc || `https://placehold.co/512x512/1a1a1a/ffffff?text=${encodeURIComponent(title)}`, sizes: '512x512', type: 'image/png' },
                        ]
                    });
                }
            }

            function updatePlayModeUI(modeId) {
                currentPlayMode = modeId;
                localStorage.setItem(PLAY_MODE_KEY, currentPlayMode);
                $('.play-mode-btn').removeClass('active');
                $(`.play-mode-btn[data-mode="${modeId}"]`).addClass('active');
            }

            function setPlayMode(targetModeId) {
                const modeInfo = Object.values(PLAY_MODES).find(m => m.id === targetModeId);
                if (!modeInfo) return;

                updatePlayModeUI(targetModeId);
                showToast(`已切换到: ${modeInfo.text}`);

                const playerModeButton = $('.qhms .random');
                if (playerModeButton.length === 0) return;

                // 获取当前模式
                let currentModeIndex = -1;
                for (let i = 0; i < PLAY_MODE_ORDER.length; i++) {
                    if (playerModeButton.hasClass(PLAY_MODE_ORDER[i].iconClass)) {
                        currentModeIndex = i;
                        break;
                    }
                }

                // 如果找不到当前模式，默认为第一个模式
                if (currentModeIndex === -1) {
                    currentModeIndex = 0;
                }

                // 找到目标模式的索引
                const targetModeIndex = PLAY_MODE_ORDER.findIndex(mode => mode.id === targetModeId);
                if (targetModeIndex === -1) return;

                // 如果已经是目标模式，确保loop属性正确
                if (currentModeIndex === targetModeIndex) {
                    if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                        myhkaudio.loop = (targetModeId === PLAY_MODES.SINGLE_LOOP.id);
                    }
                    return;
                }

                // 计算需要点击的次数（循环数组）
                let clicksNeeded;
                if (targetModeIndex >= currentModeIndex) {
                    clicksNeeded = targetModeIndex - currentModeIndex;
                } else {
                    clicksNeeded = PLAY_MODE_ORDER.length - currentModeIndex + targetModeIndex;
                }

                console.log(`播放模式切换: 当前索引${currentModeIndex} -> 目标索引${targetModeIndex}, 需要点击${clicksNeeded}次`);

                // 执行模拟点击
                let clickCount = 0;
                const clickInterval = setInterval(() => {
                    playerModeButton.trigger('click');
                    clickCount++;

                    // 检查是否达到目标模式或超过最大点击次数
                    if (playerModeButton.hasClass(modeInfo.iconClass) || clickCount >= clicksNeeded + 2) {
                        clearInterval(clickInterval);

                        // 确保loop属性设置正确
                        if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                            myhkaudio.loop = (targetModeId === PLAY_MODES.SINGLE_LOOP.id);
                        }

                        syncModeFromPlayer();
                        console.log(`播放模式切换完成，实际点击${clickCount}次`);
                    }
                }, 100); // 增加间隔时间确保每次点击都能被处理
            }

            function syncModeFromPlayer() {
                const playerModeIcon = $('.qhms .random');
                if (playerModeIcon.length === 0) return;

                // 检查播放器模式图标的类，确定当前模式
                let foundMode = false;
                for (const mode of PLAY_MODE_ORDER) {
                    if (playerModeIcon.hasClass(mode.iconClass)) {
                        if (currentPlayMode !== mode.id) {
                            updatePlayModeUI(mode.id);
                        }

                        // 无论模式是否变化，都确保audio的loop属性设置正确
                        if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                            myhkaudio.loop = (mode.id === PLAY_MODES.SINGLE_LOOP.id);
                        }

                        foundMode = true;
                        break;
                    }
                }

                // 如果没有找到匹配的模式，默认设置为专辑循环
                if (!foundMode) {
                    const defaultMode = PLAY_MODES.ALBUM_LOOP;
                    playerModeIcon.removeClass(Object.values(PLAY_MODES).map(m => m.iconClass).join(' '));
                    playerModeIcon.addClass(defaultMode.iconClass);
                    updatePlayModeUI(defaultMode.id);

                    if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                        myhkaudio.loop = false;
                    }
                }

                // 确保UI与当前模式一致
                $('.play-mode-btn').removeClass('active');
                $(`.play-mode-btn[data-mode="${currentPlayMode}"]`).addClass('active');
            }

            function initializePlayMode() {
                const savedMode = localStorage.getItem(PLAY_MODE_KEY);
                const targetModeId = savedMode ? parseInt(savedMode, 10) : PLAY_MODES.ALBUM_LOOP.id;
                updatePlayModeUI(targetModeId);

                // 确保播放模式设置正确
                const applyMode = () => {
                    if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                        // 设置audio的loop属性
                        myhkaudio.loop = (targetModeId === PLAY_MODES.SINGLE_LOOP.id);

                        // 设置播放器模式图标
                        const playerModeButton = $('.qhms .random');
                        if (playerModeButton.length > 0) {
                            const modeInfo = Object.values(PLAY_MODES).find(m => m.id === targetModeId);
                            if (modeInfo) {
                                // 移除所有模式类
                                playerModeButton.removeClass(Object.values(PLAY_MODES).map(m => m.iconClass).join(' '));
                                // 添加目标模式类
                                playerModeButton.addClass(modeInfo.iconClass);
                                console.log(`播放模式初始化: ${modeInfo.text}, loop=${myhkaudio.loop}`);
                                return true; // 成功应用模式
                            }
                        }
                    }
                    return false; // 未成功应用模式
                };

                // 立即尝试应用模式
                let success = applyMode();

                // 如果没有成功，设置重试
                if (!success) {
                    let retryCount = 0;
                    const maxRetries = 10;
                    const retryInterval = setInterval(() => {
                        success = applyMode();
                        retryCount++;
                        if (success || retryCount >= maxRetries) {
                            clearInterval(retryInterval);
                            // 最后一次尝试使用setPlayMode
                            if (!success) {
                                setTimeout(() => setPlayMode(targetModeId), 500);
                            }
                        }
                    }, 300);
                }

                // 额外的保障措施，确保模式设置成功
                setTimeout(() => {
                    setPlayMode(targetModeId);
                    // 确保UI与当前模式一致
                    $('.play-mode-btn').removeClass('active');
                    $(`.play-mode-btn[data-mode="${targetModeId}"]`).addClass('active');
                }, 2000);
            }

            $('#play-mode-controls').on('click', '.play-mode-btn', function () {
                const modeId = parseInt($(this).data('mode'), 10);
                setPlayMode(modeId);
            });

            // 播放控制按钮事件处理
            $('#play-pause-btn').on('click', function () {
                if (typeof myhkaudio === 'undefined' || !myhkaudio) return;

                if (myhkaudio.paused) {
                    myhkaudio.play();
                    showToast('播放');
                    $(this).find('i').removeClass('fa-play').addClass('fa-pause');
                } else {
                    myhkaudio.pause();
                    showToast('暂停');
                    $(this).find('i').removeClass('fa-pause').addClass('fa-play');
                }
            });

            // 更新播放/暂停按钮状态
            function updatePlayPauseButton() {
                if (typeof myhkaudio === 'undefined' || !myhkaudio) return;

                const playPauseBtn = $('#play-pause-btn');
                const icon = playPauseBtn.find('i');

                if (myhkaudio.paused) {
                    icon.removeClass('fa-pause').addClass('fa-play');
                    playPauseBtn.html('<i class="fas fa-play" style="margin-right: 5px;"></i> 播放');
                } else {
                    icon.removeClass('fa-play').addClass('fa-pause');
                    playPauseBtn.html('<i class="fas fa-pause" style="margin-right: 5px;"></i> 暂停');
                }
            }

            $('#prev-btn').on('click', function () {
                if (typeof myhkaudio === 'undefined' || !myhkaudio) return;
                if (window.localIndex > -1) { playLocal(-1); }
                else { $('.myhkprev').trigger('click'); }
                showToast('上一首');
            });

            $('#next-btn').on('click', function () {
                if (typeof myhkaudio === 'undefined' || !myhkaudio) return;
                if (window.localIndex > -1) { playLocal(1); }
                else { $('.myhknext').trigger('click'); }
                showToast('下一首');
            });

            function initializePlayerIntegration() {
                initPlayerRetries++;

                const playerReady = typeof myhkaudio !== 'undefined' && myhkaudio;
                const myhkPlayerElementsReady = $('.myhkplaylist .album-list ul').length > 0 &&
                    $('.myhkplaylist .song-list ul').length > 0 &&
                    $('.qhms .random').length > 0;

                if (playerReady && myhkPlayerElementsReady) {
                    if (playerMonitorInterval) clearInterval(playerMonitorInterval);
                    // 优化：将刷新频率从 150ms 降低到 300ms，减少CPU占用
                    playerMonitorInterval = setInterval(updateDynamicPlayerInfo, 300);
                    updateSongArtistInfoOnce();
                    bindPlayerEvents();
                    setTimeout(turnOffPlayerInternalLyrics, 1000);
                    initializePlayMode();

                    if ('mediaSession' in navigator) {
                        navigator.mediaSession.setActionHandler('play', () => myhkaudio.play());
                        navigator.mediaSession.setActionHandler('pause', () => myhkaudio.pause());
                        navigator.mediaSession.setActionHandler('previoustrack', () => $('.myhkprev').trigger('click'));
                        navigator.mediaSession.setActionHandler('nexttrack', () => $('.myhknext').trigger('click'));
                    }

                    const songListContainer = document.querySelector('.myhkplaylist .song-list ul');
                    if (songListContainer) {
                        const observer = new MutationObserver(() => {
                            if (settingsPanel.is(':visible') || playlistViewModal.is(':visible')) {
                                populateAllPlaylists();
                            }
                        });
                        observer.observe(songListContainer, { childList: true, subtree: true });
                    }

                    console.log("Player Integration Successful.");

                    // 初始化播放/暂停按钮状态
                    updatePlayPauseButton();

                } else {
                    if (initPlayerRetries < MAX_INIT_RETRIES) {
                        setTimeout(initializePlayerIntegration, RETRY_DELAY);
                    } else {
                        renderLyric("(播放器初始化失败)");
                        $('#songInfoDisplay').text("播放器初始化失败");
                        console.error("Player initialization failed after multiple retries.");
                    }
                }
            }

            function bindPlayerEvents() {
                if (typeof myhkaudio !== 'undefined' && myhkaudio && !myhkaudio.eventsBound) {
                    myhkaudio.onplay = () => {
                        // [修复] 切歌Bug修复：在播放开始时清除标志
                        isChangingTrack = false;

                        requestWakeLock();
                        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'playing';
                        updateScreensaverVisibility();
                        updatePlayPauseButton();
                    };
                    myhkaudio.onpause = () => {
                        releaseWakeLock();
                        if ('mediaSession' in navigator) navigator.mediaSession.playbackState = 'paused';
                        updateScreensaverVisibility();
                        updatePlayPauseButton();
                    };
                    myhkaudio.onended = () => {
                        renderLyric("(播放结束)");
                        songInfoLoaded = false;
                        releaseWakeLock();
                        if (window.localIndex > -1) { playLocal(1); }
                        updatePlayPauseButton();
                    };
                    myhkaudio.onemptied = () => {
                        // [修复] 切歌Bug修复：在加载新歌曲时设置标志
                        isChangingTrack = true;

                        songInfoLoaded = false;
                        renderLyric("(等待下一曲...)");
                        $('#songInfoDisplay').text("歌曲信息加载中...");
                        setTimeout(() => {
                            if (!songInfoLoaded) updateSongArtistInfoOnce();
                            // [修复] 切歌Bug修复：添加 fallback 清除标志
                            setTimeout(() => { isChangingTrack = false; }, 500);
                        }, 500);
                        if (window.localIndex > -1) return;
                    };
                    myhkaudio.onerror = () => {
                        renderLyric("(播放器错误)");
                        releaseWakeLock();
                        // [修复] 切歌Bug修复：错误也应清除标志
                        isChangingTrack = false;
                    };
                    myhkaudio.ontimeupdate = updateProgressBar;
                    myhkaudio.eventsBound = true;
                }
            }

            let lastRenderedLyricRaw = ""; // 缓存上一次渲染的歌词原始内容

            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec < 10 ? '0' + sec : sec}`;
            }

            function updateProgressBar() {
                if (typeof myhkaudio === 'undefined' || !myhkaudio) return;
                const currentTime = myhkaudio.currentTime;
                const duration = myhkaudio.duration;

                if (!isNaN(duration) && duration > 0) {
                    const percent = (currentTime / duration) * 100;
                    $('#progress-bar-fill').css('width', percent + '%');
                    $('#progress-bar-handle').css('left', percent + '%');
                    $('#current-time').text(formatTime(currentTime));
                    $('#total-time').text(formatTime(duration));
                }
            }

            function updateDynamicPlayerInfo() {
                if (typeof myhkaudio === 'undefined') return;
                const currentLyricLine = $('#myhkLrc li.myhknow');
                let lyricTextToShow = "ヾ(≧▽≦*)o";

                if (currentLyricLine.length > 0) {
                    lyricTextToShow = currentLyricLine.text().trim();
                } else if (myhkaudio.paused) {
                    lyricTextToShow = "(已暂停)";
                } else if (!myhkaudio.paused && $('#myhkLrc li').length === 0) {
                    lyricTextToShow = "ヾ(≧▽≦*)o";
                }

                // 优化：使用变量缓存比较，避免频繁读取DOM
                if (lyricTextToShow && lyricTextToShow !== lastRenderedLyricRaw) {
                    lastRenderedLyricRaw = lyricTextToShow; // 更新缓存

                    lyricsContainer.removeClass('lyric-fly-in');
                    setTimeout(() => {
                        renderLyric(lyricTextToShow);
                        lyricsContainer.addClass('lyric-fly-in');
                    }, 50);
                }

                syncModeFromPlayer();
                if (settingsPanel.is(":visible")) {
                    updateProgressBar();
                }
            }
            function updateSongArtistInfoOnce() {
                if (songInfoLoaded && !$('#songInfoDisplay').text().includes("加载中")) return;
                if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                    const title = $('div.myhkname span.myhksong span').first().text().trim();
                    const artist = $('span.myhkartist span').first().text().trim();
                    const coverArtUrl = $('.myhkcover img').attr('src');

                    if (title && artist) {
                        $('#songInfoDisplay').text(`${title} - ${artist}`);
                        songInfoLoaded = true;
                        updateMediaSession(title, artist, coverArtUrl);
                        if (settingsPanel.is(':visible') || playlistViewModal.is(':visible')) {
                            populateAllPlaylists();
                        }
                    }
                }
            }

            let toastTimer, volumeBarTimer;
            function showToast(message, duration) {
                const toast = $('#toast-notification');
                clearTimeout(toastTimer);
                duration = duration || 3500;
                $('#volume-bar-container').css('opacity', 0);
                toast.text(message).css('opacity', 1);
                toastTimer = setTimeout(() => toast.css('opacity', 0), duration);
            }
            function showVolumeBar() { const volumeBarContainer = $('#volume-bar-container'); clearTimeout(volumeBarTimer); $('#toast-notification').css('opacity', 0); const currentVolume = Math.round(myhkaudio.volume * 100); $('#volume-level-text').text(`音量: ${currentVolume}%`); $('#volume-bar-fill').css('width', `${currentVolume}%`); volumeBarContainer.css('opacity', 1); volumeBarTimer = setTimeout(() => volumeBarContainer.css('opacity', 0), 2000); }

            const SPEED_RATES = [1.0, 1.25, 1.5, 2.0, 0.75];
            let currentRateIndex = 0;
            $('#playback-speed-btn').on('click', function () {
                currentRateIndex = (currentRateIndex + 1) % SPEED_RATES.length;
                const rate = SPEED_RATES[currentRateIndex];
                $(this).text(`${rate.toFixed(rate === 1.0 ? 1 : 2)}x`);
                if (typeof myhkaudio !== 'undefined' && myhkaudio) {
                    myhkaudio.playbackRate = rate;
                }
            });

            if (!localStorage.getItem('playerHintShown')) {
                setTimeout(() => {
                    showToast("播放器面板已隐藏至左侧边缘，点击可展开");
                    localStorage.setItem('playerHintShown', 'true');
                }, 3500);
            }

            const bgContainer = $('#bg-container');
            const videoElement = document.getElementById('bg-video');
            let backgroundList = [];
            let currentBgIndex = -1;
            const defaultPlaylist = [
                { id: 'default_1', type: 'video', source: 'gist', name: '默认视频 1（素材来自：影视飓风-样片日记）', url: 'https://upyun.coren.xin/corenxin/video/video01.mp4', isValid: true, isDefault: true },
                { id: 'default_2', type: 'video', source: 'gist', name: '默认视频 2（素材来自：影视飓风-样片日记）', url: 'https://upyun.coren.xin/corenxin/video/video02.mp4', isValid: true, isDefault: true },
                { id: 'default_3', type: 'video', source: 'gist', name: '默认视频 3（素材来自：影视飓风-样片日记）', url: 'https://upyun.coren.xin/corenxin/video/video03.mp4', isValid: true, isDefault: true }
            ];

            function loadBackgroundList() {
                const storedPlaylist_v2 = localStorage.getItem(BG_LIST_KEY);
                let loadedItems = [];

                if (storedPlaylist_v2) {
                    try {
                        loadedItems = JSON.parse(storedPlaylist_v2);
                    } catch (e) { loadedItems = []; }
                } else {
                    // --- 迁移旧数据 ---
                    const oldStoredPlaylist = localStorage.getItem('customBackgroundList');
                    let oldItems = [];
                    if (oldStoredPlaylist) {
                        try {
                            oldItems = JSON.parse(oldStoredPlaylist);
                        } catch (e) { oldItems = []; }
                    }

                    const oldVideoPlaylist = localStorage.getItem('customVideoPlaylist');
                    if (oldVideoPlaylist) {
                        try {
                            const oldList = JSON.parse(oldVideoPlaylist);
                            if (Array.isArray(oldList)) {
                                oldList.forEach(item => {
                                    const url = typeof item === 'string' ? item : item.url;
                                    if (url && !oldItems.some(i => i.url === url)) {
                                        oldItems.push({
                                            id: 'migrated_' + Date.now() + Math.random(),
                                            type: 'video',
                                            url: url,
                                            isValid: item.isValid !== false,
                                            isDefault: false
                                        });
                                    }
                                });
                                localStorage.removeItem('customVideoPlaylist');
                            }
                        } catch (e) { console.error("Error migrating old playlist", e); }
                    }

                    // 转换旧数据到新结构
                    loadedItems = oldItems.map(item => ({
                        ...item,
                        source: item.isUserUploaded ? (item.type === 'image' ? 'local_image' : 'local_video') : 'gist', // 猜测来源
                        name: item.name || item.url.split('/').pop()
                    }));

                    // 迁移完成后，删除旧key
                    if (oldItems.length > 0) {
                        localStorage.removeItem('customBackgroundList');
                        // 保存一次新数据
                        localStorage.setItem(BG_LIST_KEY, JSON.stringify(loadedItems));
                    }
                    // --- 迁移结束 ---
                }

                backgroundList = [...defaultPlaylist, ...loadedItems];
            }

            // --- [已按要求修复] ---
            // 恢复保存本地文件 (data: URL) 到 localStorage
            function saveBackgroundList() {
                try {
                    // [注释掉] 这是之前过滤本地文件的代码，按你的要求注释掉
                    // const userItems = backgroundList.filter(item => !item.isDefault && !item.isUserUploaded);

                    // [恢复] 保存所有非默认项，包括本地上传的 data: URL
                    const userItems = backgroundList.filter(item => !item.isDefault);

                    localStorage.setItem(BG_LIST_KEY, JSON.stringify(userItems));
                } catch (e) {
                    console.error("保存背景列表失败 (可能是 localStorage 空间已满):", e);
                    showToast("保存背景列表失败，本地缓存可能已满！", 5000);
                }
            }

            function playRandomBackground() {
                // --- 新逻辑: 根据播放模式和勾选状态过滤 ---
                const playbackMode = localStorage.getItem(BG_PLAYBACK_MODE_KEY) || 'comprehensive';
                const enabledMap = JSON.parse(localStorage.getItem(BG_ENABLED_MAP_KEY) || '{}');

                // 获取手动标记的资源状态
                const manualValidationMap = JSON.parse(localStorage.getItem('manualValidationMap') || '{}');

                // 过滤背景列表，考虑手动标记的状态
                let playlistToUse = backgroundList.filter(item => {
                    // 如果资源被手动标记为有效，则忽略自动检测结果
                    if (manualValidationMap[item.id] === true) {
                        return true;
                    }
                    // 否则使用自动检测结果
                    return item.isValid;
                });

                if (playbackMode === 'comprehensive') {
                    // 综合模式: 播放所有勾选的 (默认全选)
                    playlistToUse = playlistToUse.filter(item => enabledMap[item.id] !== false); // 默认true
                } else if (playbackMode === 'gist') {
                    // 仅网络视频
                    playlistToUse = playlistToUse.filter(item => item.source === 'gist' || item.source === 'manual_url');
                } else if (playbackMode === 'image') {
                    // 仅图片
                    playlistToUse = playlistToUse.filter(item => item.type === 'image');
                } else if (playbackMode === 'local_video') {
                    // 仅本地视频
                    playlistToUse = playlistToUse.filter(item => item.source === 'local_video');
                }
                // --- 过滤结束 ---

                if (playlistToUse.length === 0) {
                    console.log("No valid backgrounds in current playback mode.");
                    bgContainer.css('background-image', 'none');
                    videoElement.style.opacity = '0';
                    videoElement.src = "";
                    return;
                }

                let nextIndex;
                do {
                    nextIndex = Math.floor(Math.random() * playlistToUse.length);
                } while (playlistToUse.length > 1 && playlistToUse[nextIndex].id === (currentBgIndex !== -1 ? backgroundList[currentBgIndex].id : null));

                const nextBg = playlistToUse[nextIndex];
                currentBgIndex = backgroundList.findIndex(item => item.id === nextBg.id);

                // const useAnimation = $('#bg-image-animation').is(':checked'); // 旧逻辑，移动到下面
                // bgContainer.toggleClass('animated', nextBg.type === 'image' && useAnimation); // 旧逻辑，移动到下面

                if (nextBg.type === 'image') {
                    videoElement.style.opacity = '0';
                    videoElement.pause();

                    // --- [修复] 图片直接交叉淡入淡出逻辑 ---
                    const oldImageUrl = bgContainer.css('background-image'); // 1. 获取当前图片

                    // 2. 将新图片设置到主容器 (立即生效，但会被伪元素遮挡)
                    bgContainer.css('background-image', `url("${nextBg.url}")`);

                    // 3. 将旧图片设置到伪元素，并让伪元素可见
                    bgContainer.css('--before-bg-image', oldImageUrl); // 使用 CSS 变量传递 URL
                    bgContainer.addClass('crossfading'); // 触发伪元素显示 (opacity: 1)

                    // 4. 应用缩放动画到主容器 (伪元素不应用)
                    const useAnimation = $('#bg-image-animation').is(':checked');
                    bgContainer.toggleClass('animated', useAnimation); // 主容器动画

                    // 5. 短暂延迟后，让伪元素淡出
                    setTimeout(() => {
                        bgContainer.removeClass('crossfading'); // 触发伪元素淡出 (opacity: 0)
                        // 淡出完成后清理伪元素背景 (可选，防止旧图片残留)
                        setTimeout(() => {
                            if (!bgContainer.hasClass('crossfading')) { // 再次检查以防快速切换
                                bgContainer.css('--before-bg-image', 'none');
                            }
                        }, 400); // 必须等于或大于 CSS transition-duration
                    }, 50); // 立即开始淡出伪元素
                    // --- 结束修复 ---

                    startBackgroundChangeTimer();
                } else {
                    // --- [修复] 切换到视频时，确保伪元素是隐藏的 ---
                    bgContainer.removeClass('crossfading animated');
                    bgContainer.css('--before-bg-image', 'none');
                    // --- 结束修复 ---

                    bgContainer.css('opacity', 1);
                    bgContainer.css('background-image', 'none');
                    // bgContainer.removeClass('animated'); // 已在上面移除
                    videoElement.src = nextBg.url;
                    videoElement.style.opacity = '1';
                    // 确保视频可以在移动设备上与音频同时播放
                    videoElement.setAttribute('playsinline', '');
                    videoElement.setAttribute('webkit-playsinline', '');
                    videoElement.setAttribute('x5-playsinline', '');
                    videoElement.setAttribute('x5-video-player-type', 'h5');
                    videoElement.setAttribute('x5-video-player-fullscreen', 'false');
                    videoElement.play().catch(error => {
                        console.error("Video play error, trying next one.", error);
                        handleBackgroundError(nextBg.url);
                    });
                    stopBackgroundChangeTimer();
                }
            }

            function handleBackgroundError(errorUrl) {
                const itemIndex = backgroundList.findIndex(item => item.url === errorUrl);
                if (itemIndex > -1) {
                    // 检查是否被手动标记过
                    const manualValidationMap = JSON.parse(localStorage.getItem('manualValidationMap') || '{}');
                    if (manualValidationMap[backgroundList[itemIndex].id] !== undefined) {
                        console.log(`资源已被手动标记，保持当前状态: ${errorUrl}`);
                    } else {
                        backgroundList[itemIndex].isValid = false;
                        saveBackgroundList();
                        if (settingsPanel.is(':visible')) populateBackgroundList();
                    }
                }
                setTimeout(playRandomBackground, 1000);
            }

            // 背景切换定时器
            // let backgroundChangeTimer = null; // [修复] 移动到 $(document).ready 顶部
            const BG_CHANGE_INTERVAL_KEY = 'bgChangeInterval';
            const savedBgInterval = localStorage.getItem(BG_CHANGE_INTERVAL_KEY);
            let bgChangeInterval = (savedBgInterval !== null) ? parseInt(savedBgInterval) : 30; // 默认30秒

            function startBackgroundChangeTimer() {
                stopBackgroundChangeTimer();
                if (bgChangeInterval > 0) {
                    timerStartTime = Date.now();
                    timerRemaining = bgChangeInterval * 1000;
                    backgroundChangeTimer = setTimeout(playRandomBackground, timerRemaining);
                }
            }

            function stopBackgroundChangeTimer() {
                if (backgroundChangeTimer) {
                    clearTimeout(backgroundChangeTimer);
                    backgroundChangeTimer = null;
                }
                timerStartTime = 0;
                timerRemaining = 0;
            }

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    if (backgroundChangeTimer) {
                        clearTimeout(backgroundChangeTimer);
                        backgroundChangeTimer = null;
                        const elapsed = Date.now() - timerStartTime;
                        timerRemaining = Math.max(0, timerRemaining - elapsed);
                    }
                } else if (document.visibilityState === 'visible') {
                    const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                    if (currentBg && currentBg.type === 'image' && bgChangeInterval > 0 && timerRemaining > 0) {
                        backgroundChangeTimer = setTimeout(playRandomBackground, timerRemaining);
                        timerStartTime = Date.now();
                    }
                }
            });

            // 视频播放结束时，自动播放下一个随机背景
            videoElement.addEventListener('ended', playRandomBackground);
            videoElement.addEventListener('error', (e) => {
                console.error("Video loading error.", e);
                handleBackgroundError(videoElement.src);
            });




            $('#bg-image-animation').on('change', function () {
                localStorage.setItem('bgImageAnimation', $(this).is(':checked'));
                const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                if (currentBg && currentBg.type === 'image') {
                    bgContainer.toggleClass('animated', $(this).is(':checked'));
                }
            });

            // 内容突出显示设置
            $('#content-highlight').on('change', function () {
                const isEnabled = $(this).is(':checked');
                localStorage.setItem('contentHighlight', isEnabled);
                $('#overlay-opacity-container').toggle(isEnabled);
                $('#content-overlay').toggleClass('active', isEnabled);
            });

            // 蒙版不透明度设置
            $('#overlay-opacity').on('input', function () {
                const opacity = $(this).val();
                $('#overlay-opacity-value').text(opacity + '%');
                $('#content-overlay').css('background-color', `rgba(0, 0, 0, ${opacity / 100})`);
                localStorage.setItem('overlayOpacity', opacity);
            });

            function initializeBgSettings() {
                const savedAnimation = localStorage.getItem('bgImageAnimation');
                const isAnimated = savedAnimation === 'true';
                $('#bg-image-animation').prop('checked', isAnimated);
                // if (isAnimated) { // 不需要在初始化时添加，playRandomBackground 会处理
                //     bgContainer.toggleClass('animated', isAnimated); 
                // }

                // 初始化背景切换间隔设置 (已修改为秒，默认30)
                const savedInterval = localStorage.getItem(BG_CHANGE_INTERVAL_KEY);
                if (savedInterval !== null) {
                    bgChangeInterval = parseInt(savedInterval);
                    $('#bg-change-interval').val(bgChangeInterval);
                } else {
                    bgChangeInterval = 30; // 默认30秒
                    $('#bg-change-interval').val(30);
                    localStorage.setItem(BG_CHANGE_INTERVAL_KEY, '30');
                }

                // 初始化内容突出显示设置
                const savedHighlight = localStorage.getItem('contentHighlight');
                const isHighlightEnabled = savedHighlight === 'true';
                $('#content-highlight').prop('checked', isHighlightEnabled);
                if (isHighlightEnabled) {
                    $('#overlay-opacity-container').show();
                    $('#content-overlay').addClass('active');
                }

                // 初始化蒙版不透明度设置
                const savedOpacity = localStorage.getItem('overlayOpacity');
                if (savedOpacity !== null) {
                    $('#overlay-opacity').val(savedOpacity);
                    $('#overlay-opacity-value').text(savedOpacity + '%');
                    $('#content-overlay').css('background-color', `rgba(0, 0, 0, ${savedOpacity / 100})`);
                }

                // --- (这里是你上一步添加的 bg-playback-mode 逻辑，保持不变) ---
                const savedPlaybackMode = localStorage.getItem(BG_PLAYBACK_MODE_KEY);
                if (savedPlaybackMode) {
                    $('#bg-playback-mode').val(savedPlaybackMode);
                }
                $('#bg-playback-mode').on('change', function () {
                    localStorage.setItem(BG_PLAYBACK_MODE_KEY, $(this).val());
                    playRandomBackground(); // 立即应用新模式
                });
                // --- ( ... ) ---

                // 绑定背景切换间隔变更事件 (已修改为处理 number input)
                $('#bg-change-interval').on('change', function () {
                    let newInterval = parseInt($(this).val());
                    if (isNaN(newInterval) || newInterval < 0) {
                        newInterval = 0;
                        $(this).val(0); // 纠正无效输入
                    }
                    bgChangeInterval = newInterval;
                    localStorage.setItem(BG_CHANGE_INTERVAL_KEY, newInterval.toString());

                    // 如果当前是图片背景，重新启动定时器
                    const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                    if (currentBg && currentBg.type === 'image') {
                        startBackgroundChangeTimer();
                    }
                });

                $('#reset-bg-change-interval').on('click', function () {
                    bgChangeInterval = 30;
                    $('#bg-change-interval').val(30);
                    localStorage.setItem(BG_CHANGE_INTERVAL_KEY, '30');
                    const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                    if (currentBg && currentBg.type === 'image') startBackgroundChangeTimer();
                    showToast('已重置图片切换间隔为 30 秒');
                });



                loadBackgroundList();

                // 封装文件添加逻辑 (已修复竞态条件)
                const addFilesToPlaylist = (files, type, source) => {
                    let loadedItemsCount = 0; // 统计成功加载的数量
                    let processedCount = 0;   // 统计已处理的数量
                    const totalFiles = files ? files.length : 0;

                    if (totalFiles === 0) return;

                    Array.from(files).forEach(file => {
                        const reader = new FileReader();

                        reader.onload = function (event) {
                            // 仅当成功时才创建
                            const dataUrl = event.target.result;
                            const newItem = {
                                id: 'user_' + Date.now() + '_' + Math.random(),
                                type: type, source: source, url: dataUrl,
                                name: file.name, isValid: true, isDefault: false,
                                isUserUploaded: true
                            };
                            backgroundList.push(newItem);
                            loadedItemsCount++; // 成功+1
                        };

                        reader.onerror = function (event) {
                            console.error("文件读取失败:", file.name, event.target.error);
                        };

                        // [修复] 关键：使用 onloadend 
                        // 无论成功(onload)还是失败(onerror)，onloadend 总是会触发
                        reader.onloadend = function () {
                            processedCount++; // 处理+1

                            // 当所有文件都处理完毕时
                            if (processedCount === totalFiles) {
                                saveBackgroundList(); // 按你的要求，仍然调用旧的保存函数

                                // [修复] 这一行必须在 saveBackgroundList 之后，
                                // 并且要确保它总能执行
                                populateBackgroundList();

                                if (loadedItemsCount > 0) {
                                    // 提示用户本地文件不会被保存
                                    // showToast(`${loadedItemsCount} 个文件已添加 (仅限本次会话)`);

                                    // [修复] 更改回原始提示 (配合恢复 saveBackgroundList)
                                    showToast(`${loadedItemsCount} 个文件已添加`);
                                } else {
                                    showToast("文件添加失败，请检查控制台");
                                }
                            }
                        };

                        reader.readAsDataURL(file); // 开始读取
                    });
                };

                // 绑定多文件上传: 图片
                $('#upload-images').on('change', function (e) {
                    addFilesToPlaylist(e.target.files, 'image', 'local_image');
                    $(this).val(''); // 清空选择
                });

                // 绑定多文件上传: 视频
                $('#upload-local-videos').on('change', function (e) {
                    addFilesToPlaylist(e.target.files, 'video', 'local_video');
                    $(this).val(''); // 清空选择
                });

                // 绑定添加图片URL
                $('#add-image-url-btn').on('click', function () {
                    const newUrlInput = $('#new-image-url').val().trim();
                    if (newUrlInput) {
                        // 分割多个URL（按换行符分割）
                        const urls = newUrlInput.split(/[\n\r]+/).filter(url => url.trim().length > 0);
                        urls.forEach(url => {
                            executePendingAction({ type: 'add', payload: { url: url.trim(), type: 'image', source: 'image_url' } });
                        });
                        // 清空输入框
                        $('#new-image-url').val('');
                    }
                });

                // 绑定列表勾选事件
                videoListContainer.on('change', '.bg-item-enable', function () {
                    const id = $(this).closest('.video-list-item').data('id');
                    const isEnabled = $(this).is(':checked');
                    let enabledMap = JSON.parse(localStorage.getItem(BG_ENABLED_MAP_KEY) || '{}');
                    enabledMap[id] = isEnabled;
                    localStorage.setItem(BG_ENABLED_MAP_KEY, JSON.stringify(enabledMap));
                });

                // 绑定全选/全不选
                const setAllCheckboxes = (enabled, type = null) => {
                    let enabledMap = JSON.parse(localStorage.getItem(BG_ENABLED_MAP_KEY) || '{}');
                    backgroundList.forEach(item => {
                        if (type === null || item.type === type) {
                            enabledMap[item.id] = enabled;
                        }
                    });
                    localStorage.setItem(BG_ENABLED_MAP_KEY, JSON.stringify(enabledMap));
                    populateBackgroundList(); // 刷新列表显示
                };
                $('#select-all-bg-btn').on('click', () => setAllCheckboxes(true));
                $('#select-all-images-btn').on('click', () => setAllCheckboxes(true, 'image'));
                $('#select-all-videos-btn').on('click', () => setAllCheckboxes(true, 'video'));
                $('#deselect-all-bg-btn').on('click', () => setAllCheckboxes(false));

                // 绑定粘贴
                $('#paste-from-clipboard-btn').on('click', async () => {
                    try {
                        const clipboardItems = await navigator.clipboard.read();
                        let itemsAdded = 0;
                        for (const item of clipboardItems) {
                            if (item.types.includes('text/plain')) {
                                const text = await (await item.getType('text/plain')).text();
                                const urls = text.split(/[\n\s]+/).filter(line => line.startsWith('http'));
                                if (urls.length > 0) {
                                    for (const url of urls) {
                                        const type = /\.(jpe?g|png|gif|webp)$/i.test(url) ? 'image' : 'video';
                                        const source = type === 'image' ? 'image_url' : 'manual_url';
                                        // 粘贴不需要密码，直接调用 executePendingAction
                                        // 确保 executePendingAction 是 async
                                        await executePendingAction({ type: 'add', payload: { url, type, source } });
                                        itemsAdded++;
                                    }
                                }
                            } else if (item.types.some(t => t.startsWith('image/'))) {
                                const imageType = item.types.find(t => t.startsWith('image/'));
                                const blob = await item.getType(imageType);
                                const reader = new FileReader();
                                reader.onload = function (event) {
                                    const dataUrl = event.target.result;
                                    const newItem = {
                                        id: 'paste_' + Date.now(),
                                        type: 'image',
                                        source: 'local_image', // 视为本地
                                        url: dataUrl,
                                        name: `粘贴的图片 ${new Date().toLocaleTimeString()}`,
                                        isValid: true, isDefault: false, isUserUploaded: true
                                    };
                                    backgroundList.push(newItem);
                                    saveBackgroundList();
                                    populateBackgroundList();
                                    itemsAdded++;
                                };
                                reader.readAsDataURL(blob);
                            }
                        }
                        if (itemsAdded > 0) {
                            setTimeout(() => showToast(`从剪贴板添加了 ${itemsAdded} 个项目`), 500);
                        } else {
                            showToast('剪贴板中未找到可粘贴的内容');
                        }
                    } catch (err) {
                        console.error('粘贴失败: ', err);
                        showToast('粘贴失败，或未授予剪贴板权限');
                    }
                });

                playRandomBackground();
            }


            // const correctPassword = '123456jkl'; // [修复] 注释掉密码
            const GIST_URL_KEY = 'lastGistUrl';

            const settingsButton = $('#settings-button');
            const settingsPanel = $('#settings-panel');
            const closeSettingsBtn = $('#close-settings');

            // const passwordModal = $('#password-modal'); // [修复] 注释掉
            // const closePasswordModalBtn = $('#close-password-modal'); // [修复] 注释掉
            // const passwordForm = $('#password-form'); // [修复] 注释掉
            // const passwordInput = $('#password-input'); // [修复] 注释掉
            // const togglePasswordBtn = $('#toggle-password-visibility'); // [修复] 注释掉

            const gistUrlInput = $('#gist-url-input');
            const loadFromGistBtn = $('#load-from-gist-btn');

            const addManuallyVideoBtn = $('#add-manually-video-btn');
            const newVideoUrlInput = $('#new-video-url');

            const copyPlaylistBtn = $('#copy-playlist-btn');

            const videoPreviewModal = $('#video-preview-modal');
            const videoPreviewPlayer = $('#video-preview-player');
            const closeVideoPreviewBtn = $('#close-video-preview');
            const contextMenu = $('#custom-context-menu');
            function openContextMenu(x, y) {
                const isPaused = (typeof myhkaudio === 'undefined') || myhkaudio.paused;
                contextMenu.html(`
                    <div class="context-menu-item" id="ctx-playpause"><i class="fas ${isPaused ? 'fa-play' : 'fa-pause'}"></i><span>${isPaused ? '播放' : '暂停'}</span></div>
                    <div class="context-menu-item" id="ctx-prev"><i class="fas fa-step-backward"></i><span>上一曲</span></div>
                    <div class="context-menu-item" id="ctx-next"><i class="fas fa-step-forward"></i><span>下一曲</span></div>
                    <div class="context-menu-item" id="ctx-playlist"><i class="fas fa-list"></i><span>播放列表</span></div>
                    <div class="context-menu-item" id="ctx-settings"><i class="fas fa-sliders-h"></i><span>设置</span></div>
                    <div class="context-menu-item" id="ctx-fullscreen"><i class="fas fa-expand"></i><span>全屏</span></div>
                `);
                contextMenu.css({ left: x + 'px', top: y + 'px' }).show().addClass('open');
                $('#ctx-playpause').on('click', () => { if (typeof myhkaudio !== 'undefined') myhkaudio.paused ? myhkaudio.play() : myhkaudio.pause(); contextMenu.hide(); });
                $('#ctx-prev').on('click', () => { $('#prev-btn').trigger('click'); contextMenu.hide(); });
                $('#ctx-next').on('click', () => { $('#next-btn').trigger('click'); contextMenu.hide(); });
                $('#ctx-playlist').on('click', () => { viewPlaylistBtn.trigger('click'); contextMenu.hide(); });
                $('#ctx-settings').on('click', () => { settingsButton.trigger('click'); contextMenu.hide(); });
                $('#ctx-fullscreen').on('click', () => { toggleFullscreen(); contextMenu.hide(); });
            }
            $(document).on('contextmenu', function (e) {
                e.preventDefault();
                openContextMenu(e.clientX, e.clientY);
            });
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#custom-context-menu').length) {
                    contextMenu.removeClass('open').hide();
                }
            });

            // let pendingAction = null; // [修复] 注释掉

            async function validateVideoUrl(url) {
                // 对于 data: URL 和 blob: URL，我们假定它们总是有效的
                if (url.startsWith('data:') || url.startsWith('blob:')) {
                    return true;
                }
                // 对于网络 URL，尝试发送 HEAD 请求
                try {
                    // 使用 'no-cors' 模式可以避免 CORS 问题，但这可能导致误判（即使资源存在也可能失败）
                    // 如果需要更准确的检查，服务器需要配置 CORS
                    const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                    // 在 no-cors 模式下，我们无法直接检查 response.ok 或 status
                    // 如果请求没有抛出网络错误，我们乐观地认为它是有效的
                    return true;
                } catch (e) {
                    console.warn(`Validation failed for ${url}:`, e);
                    // 网络错误或其他问题，认为无效
                    return false;
                }
            }


            function populateBackgroundList() {
                videoListContainer.empty();
                videoCountSpan.text(`(${backgroundList.length}个)`);
                const enabledMap = JSON.parse(localStorage.getItem(BG_ENABLED_MAP_KEY) || '{}');
                // 获取手动标记的资源状态
                const manualValidationMap = JSON.parse(localStorage.getItem('manualValidationMap') || '{}');

                if (backgroundList.length === 0) {
                    videoListContainer.html('<p style="color: #888; text-align: center;">列表为空</p>');
                    return;
                }

                const sourceIcons = {
                    'gist': 'fas fa-cloud',
                    'manual_url': 'fas fa-link',
                    'image_url': 'fas fa-image',
                    'local_image': 'fas fa-file-image',
                    'local_video': 'fas fa-file-video',
                };

                backgroundList.forEach(item => {
                    let statusLabel = '';
                    let isManuallyValidated = manualValidationMap[item.id] !== undefined;

                    if (item.isChecking) {
                        statusLabel = '<span class="status-label checking-label">(检测中...)</span>';
                    } else if (!item.isValid) {
                        if (isManuallyValidated) {
                            statusLabel = '<span class="status-label manual-label">(手动标记' +
                                (manualValidationMap[item.id] ? '有效' : '无效') + ')</span>';
                        } else {
                            statusLabel = '<span class="status-label invalid-label">(已失效)</span>';
                        }
                    } else if (isManuallyValidated) {
                        statusLabel = '<span class="status-label manual-label">(手动标记有效)</span>';
                    }

                    // 默认勾选
                    const isEnabled = enabledMap[item.id] !== false;
                    const iconClass = sourceIcons[item.source] || 'fas fa-question-circle';

                    // 对 data: URL 进行截断显示
                    let displayName = item.name || item.url;
                    if (displayName.startsWith('data:')) {
                        displayName = `${item.name || '本地文件'} (${displayName.substring(5, displayName.indexOf(';'))})`; // 显示文件名和类型
                    }

                    const listItem = $(`
                        <div class="video-list-item" data-id="${item.id}">
                            <input type="checkbox" class="bg-item-enable" ${isEnabled ? 'checked' : ''} title="是否在综合模式下播放">
                            <i class="${iconClass}" style="margin: 0 8px; color: #ccc;" title="来源: ${item.source}"></i>
                            <span class="video-list-item-url" title="${item.url}">${displayName}</span>
                            ${statusLabel}
                            <div class="video-item-actions">
                                <button class="validate-btn" title="手动标记为有效">✓</button>
                                <button class="preview-btn" title="预览">▶️</button>
                                <button class="delete-bg-btn" title="删除">🗑️</button>
                            </div>
                        </div>
                    `);
                    videoListContainer.append(listItem);

                    // 添加手动标记按钮点击事件
                    listItem.find('.validate-btn').on('click', function () {
                        const itemId = $(this).closest('.video-list-item').data('id');
                        const item = backgroundList.find(bg => bg.id === itemId);
                        if (!item) return;

                        // 获取手动标记状态
                        let manualValidationMap = JSON.parse(localStorage.getItem('manualValidationMap') || '{}');

                        // 标记为有效
                        manualValidationMap[itemId] = true;

                        // 更新项目状态
                        item.isValid = true;
                        item.isManuallyValidated = true;

                        // 保存状态
                        localStorage.setItem('manualValidationMap', JSON.stringify(manualValidationMap));
                        saveBackgroundList();

                        // 刷新列表
                        populateBackgroundList();
                        showToast("已手动标记为有效资源");
                    });
                });
            }

            /* // [修复] 注释掉整个 requestPassword 函数
            function requestPassword(action) {
                // ... (原函数内容) ...
            }
            */ // [修复] 结束注释

            function executeDeleteAction(idToDelete) {
                const itemToDelete = backgroundList.find(item => item.id === idToDelete);
                if (!itemToDelete) return;

                const isPlaying = (itemToDelete.type === 'video' && videoElement.src === itemToDelete.url) ||
                    (itemToDelete.type === 'image' && bgContainer.css('background-image').includes(itemToDelete.url));

                backgroundList = backgroundList.filter(item => item.id !== idToDelete);
                saveBackgroundList();
                populateBackgroundList();
                showToast("背景已删除");

                if (isPlaying) {
                    playRandomBackground();
                }
            }

            // [修复] 修改函数签名以接受 action 参数
            async function executePendingAction(action) {
                // if (!pendingAction) return; // [修复] 不再需要检查 pendingAction
                // const { type, payload } = pendingAction; // [修复] 直接使用传入的 action
                if (!action) return; // [修复] 检查传入的 action
                const { type, payload } = action;

                if (type === 'add') {
                    // payload 现在是一个对象: { url, type, source, name }
                    if (payload && payload.url) {
                        // 对 data: URL 不进行重复检查，因为每次生成的 URL 可能不同
                        const urlExists = !payload.url.startsWith('data:') && backgroundList.some(item => item.url === payload.url);
                        if (urlExists) {
                            showToast("内容已存在");
                        } else {
                            const isValid = await validateVideoUrl(payload.url);
                            const newItem = {
                                id: 'manual_' + Date.now() + '_' + Math.random(), // 确保 ID 唯一性
                                type: payload.type,
                                source: payload.source,
                                url: payload.url,
                                name: payload.name || payload.url.split('/').pop(),
                                isValid,
                                isDefault: false
                            };
                            backgroundList.push(newItem);
                            saveBackgroundList();
                            populateBackgroundList();

                            // 清空对应的输入框
                            if (payload.source === 'manual_url') newVideoUrlInput.val('');
                            if (payload.source === 'image_url') $('#new-image-url').val('');

                            showToast(`网络${payload.type === 'image' ? '图片' : '视频'}已添加 ${isValid ? '' : '(可能失效)'}`);
                        }
                    }
                } else if (type === 'delete') {
                    executeDeleteAction(payload); // 调用删除
                }
                // pendingAction = null; // [修复] 不再需要
                // passwordModal.hide(); // [修复] 不再需要
                // passwordInput.val(''); // [修复] 不再需要
            }

            settingsButton.on('click', () => {
                populateBackgroundList();
                populateAllPlaylists();
                settingsPanel.css('display', 'flex');
                // 强制重绘以触发过渡
                settingsPanel[0].offsetHeight;
                settingsPanel.addClass('active');

                // 修复：确保当前专辑的歌曲列表自动显示
                // 找到当前正在播放的专辑
                const currentAlbum = $('.myhkplaylist .album-list ul li.myhknow');
                if (currentAlbum.length) {
                    // 模拟点击当前专辑，以确保歌曲列表显示
                    const albumIndex = currentAlbum.index();
                    // 触发点击事件以显示歌曲列表
                    $('.playlist-item[data-index="' + albumIndex + '"]').first().trigger('click');
                }
            });

            closeSettingsBtn.on('click', () => {
                settingsPanel.removeClass('active');
                setTimeout(() => settingsPanel.hide(), 300); // 等待过渡结束
            });

            /* // [修复] 注释掉密码模态框事件
            closePasswordModalBtn.on('click', () => {
                passwordModal.hide();
                passwordInput.val('');
                pendingAction = null;
            });

            togglePasswordBtn.on('click', function() {
                const isPassword = passwordInput.attr('type') === 'password';
                passwordInput.attr('type', isPassword ? 'text' : 'password');
                $('#eye-open').toggle(!isPassword);
                $('#eye-closed').toggle(isPassword);
            });

            passwordForm.on('submit', (e) => {
                e.preventDefault();
                if (passwordInput.val() === correctPassword) {
                    executePendingAction(); // 这个调用不再需要，因为我们直接调用 executePendingAction
                } else {
                    showToast("密码错误");
                    passwordInput.val('');
                }
            });
            */ // [修复] 结束注释

            addManuallyVideoBtn.on('click', (e) => {
                e.preventDefault();
                const newUrlInput = newVideoUrlInput.val().trim();
                if (newUrlInput) {
                    // 分割多个URL（按换行符分割）
                    const urls = newUrlInput.split(/[\n\r]+/).filter(url => url.trim().length > 0);
                    urls.forEach(url => {
                        executePendingAction({ type: 'add', payload: { url: url.trim(), type: 'video', source: 'manual_url' } });
                    });
                    // 清空输入框
                    newVideoUrlInput.val('');
                }
            });

            videoListContainer.on('click', '.delete-bg-btn', function () {
                const idToDelete = $(this).closest('.video-list-item').data('id');
                // const itemToDelete = backgroundList.find(item => item.id === idToDelete); // [修复] 不再需要检查类型
                // if (itemToDelete && itemToDelete.isUserUploaded) { // [修复] 不再需要检查类型
                //     executeDeleteAction(idToDelete); // [修复] 直接删除
                // } else {
                //     requestPassword({ type: 'delete', payload: idToDelete }); // [修复] 注释掉密码请求
                // }
                executeDeleteAction(idToDelete); // [修复] 总是直接删除
            });

            videoListContainer.on('click', '.preview-btn', function () {
                const idToPreview = $(this).closest('.video-list-item').data('id');
                const item = backgroundList.find(i => i.id === idToPreview);
                if (!item) return;

                if (item.type === 'image') {
                    showToast("图片不支持预览，将直接设为背景", 2000);
                    currentBgIndex = backgroundList.findIndex(i => i.id === idToPreview);

                    // --- [修复] 预览图片时也使用交叉淡入淡出 ---
                    const oldImageUrl = bgContainer.css('background-image');
                    bgContainer.css('background-image', `url("${item.url}")`);
                    bgContainer.css('--before-bg-image', oldImageUrl);
                    bgContainer.addClass('crossfading');
                    const useAnimation = $('#bg-image-animation').is(':checked');
                    bgContainer.toggleClass('animated', useAnimation);
                    setTimeout(() => {
                        bgContainer.removeClass('crossfading');
                        setTimeout(() => {
                            if (!bgContainer.hasClass('crossfading')) {
                                bgContainer.css('--before-bg-image', 'none');
                            }
                        }, 400);
                    }, 50);
                    // --- 结束修复 ---

                    videoElement.style.opacity = '0';
                    videoElement.pause();
                    stopBackgroundChangeTimer(); // 预览时不自动切换
                } else {
                    videoPreviewModal.css('display', 'flex');
                    // 强制重绘
                    videoPreviewModal[0].offsetHeight;
                    videoPreviewModal.addClass('active');
                    videoPreviewPlayer.attr('src', item.url);
                }
            });

            closeVideoPreviewBtn.on('click', function () {
                videoPreviewModal.removeClass('active');
                setTimeout(() => {
                    videoPreviewModal.hide();
                    videoPreviewPlayer.get(0).pause();
                    videoPreviewPlayer.attr('src', '');
                }, 300);
            });

            const savedGistUrl = localStorage.getItem(GIST_URL_KEY);
            if (savedGistUrl) { gistUrlInput.val(savedGistUrl); }

            loadFromGistBtn.on('click', async () => {
                const url = gistUrlInput.val().trim();
                if (!url) { showToast("请输入 Gist Raw 链接"); return; }
                loadFromGistBtn.text('加载中...').prop('disabled', true);
                try {
                    const response = await fetch(url, { cache: "no-store" });
                    if (!response.ok) throw new Error(`网络响应错误: ${response.statusText}`);
                    const text = await response.text();
                    let rawList = [];
                    try {
                        const parsedData = JSON.parse(text);
                        if (Array.isArray(parsedData)) rawList = parsedData;
                    } catch (e) {
                        rawList = text.split('\n').map(line => line.trim()).filter(line => line.length > 0 && line.startsWith('http'));
                    }
                    if (!Array.isArray(rawList)) throw new Error('无法识别 Gist 内容格式');

                    const newItems = [];
                    let duplicateCount = 0;
                    rawList.forEach(item => {
                        const itemUrl = typeof item === 'object' ? item.url : item;
                        if (backgroundList.some(pItem => pItem.url === itemUrl)) {
                            duplicateCount++;
                        } else {
                            // 判断URL是否为图片（通过扩展名）
                            const isImage = /\.(jpg|jpeg|png|gif|webp|svg|bmp)$/i.test(itemUrl);
                            newItems.push({
                                id: 'gist_' + Date.now() + Math.random(),
                                type: isImage ? 'image' : 'video', // 根据URL判断类型
                                source: 'gist', // 明确来源
                                url: itemUrl,
                                name: typeof item === 'object' ? item.name : itemUrl.split('/').pop(), // 尝试获取名称
                                isValid: isImage ? true : true, // 图片默认有效，视频需要验证
                                isChecking: isImage ? false : true, // 图片不需要检查，视频需要检查
                                isDefault: false
                            });
                        }
                    });

                    backgroundList.push(...newItems);
                    populateBackgroundList(); // 先显示出来，标记为检查中

                    let invalidCount = 0;
                    // 并行验证所有新添加的 URL
                    const validationPromises = newItems.map(async (item) => {
                        const isValid = await validateVideoUrl(item.url);
                        const itemInPlaylist = backgroundList.find(pItem => pItem.id === item.id);
                        if (itemInPlaylist) {
                            itemInPlaylist.isChecking = false; // 移除检查中状态
                            itemInPlaylist.isValid = isValid; // 更新有效性
                            if (!isValid) invalidCount++;
                        }
                    });

                    await Promise.all(validationPromises); // 等待所有验证完成
                    saveBackgroundList(); // 保存包含有效性状态的列表
                    populateBackgroundList(); // 再次刷新列表，显示最终状态
                    localStorage.setItem(GIST_URL_KEY, url);
                    showToast(`加载完成! 新增 ${newItems.length}, 重复 ${duplicateCount}, 失效 ${invalidCount}。`, 5000);

                    // 如果当前背景是无效的，或者没有背景在播放，则尝试播放一个新的
                    const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                    if (!currentBg || !currentBg.isValid || (currentBg.type === 'video' && videoElement.paused)) {
                        playRandomBackground();
                    }
                } catch (error) {
                    console.error("加载 Gist 失败:", error);
                    showToast("加载 Gist 失败: " + error.message, 5000);
                } finally {
                    loadFromGistBtn.text('从URL加载').prop('disabled', false);
                }
            });

            copyPlaylistBtn.on('click', function () {
                // 仅复制非默认、非本地上传的有效链接
                const listToCopy = backgroundList.filter(item => !item.isDefault && !item.isUserUploaded && item.isValid);
                if (listToCopy.length === 0) { showToast("可复制的网络链接列表为空"); return; }
                const urlList = listToCopy.map(item => item.url);
                const playlistString = urlList.join('\n'); // 改为纯文本，一行一个URL

                // 尝试使用 Clipboard API (更现代)
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(playlistString).then(() => {
                        showToast("已复制链接列表到剪贴板");
                    }).catch(err => {
                        showToast("复制失败 (API)");
                        console.error('Clipboard API copy failed:', err);
                    });
                } else {
                    // Fallback to execCommand (旧方法)
                    const textArea = document.createElement("textarea");
                    textArea.value = playlistString;
                    textArea.style.position = "fixed"; textArea.style.top = "-9999px"; textArea.style.left = "-9999px";
                    document.body.appendChild(textArea);
                    textArea.focus(); textArea.select();
                    try {
                        document.execCommand('copy');
                        showToast("已复制链接列表到剪贴板 (Fallback)");
                    } catch (err) {
                        showToast("复制失败 (Fallback)");
                        console.error('execCommand copy failed:', err);
                    }
                    document.body.removeChild(textArea);
                }
            });


            let mouseTimer = null;
            const MOUSE_IDLE_TIMEOUT = 3000;
            function hideCursor() { $('html').addClass('no-cursor'); }
            $(document).on('mousemove', function () {
                $('html').removeClass('no-cursor');
                clearTimeout(mouseTimer);
                mouseTimer = setTimeout(hideCursor, MOUSE_IDLE_TIMEOUT);
            });
            mouseTimer = setTimeout(hideCursor, MOUSE_IDLE_TIMEOUT);

            let touchStartX = 0, touchStartY = 0, touchMoved = false;
            $('body').on('touchstart', e => {
                if ($(e.target).closest('#settings-panel, #password-modal, #video-preview-modal, #playlist-view-modal').length > 0) return;
                touchStartX = e.originalEvent.touches[0].clientX;
                touchStartY = e.originalEvent.touches[0].clientY;
                touchMoved = false;
            });
            $('body').on('touchmove', e => {
                if ($(e.target).closest('#settings-panel, #password-modal, #video-preview-modal, #playlist-view-modal').length > 0) return;
                touchMoved = true;
            });
            $('body').on('touchend', e => {
                if ($(e.target).closest('#settings-panel, #password-modal, #video-preview-modal, #playlist-view-modal').length > 0) return;
                if (typeof myhkaudio === 'undefined') return;
                if (touchMoved) {
                    const deltaX = e.originalEvent.changedTouches[0].clientX - touchStartX;
                    const deltaY = e.originalEvent.changedTouches[0].clientY - touchStartY;
                    if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 40) {
                        if (deltaX < 0) { $('.myhknext').trigger('click'); showToast('下一首'); }
                        else { $('.myhkprev').trigger('click'); showToast('上一首'); }
                    } else if (Math.abs(deltaY) > 40) {
                        if (deltaY < 0) { myhkaudio.volume = Math.min(myhkaudio.volume + 0.1, 1.0); }
                        else { myhkaudio.volume = Math.max(myhkaudio.volume - 0.1, 0.0); }
                        showVolumeBar();
                    }
                } else {
                    myhkaudio.paused ? myhkaudio.play() : myhkaudio.pause();
                    showToast(myhkaudio.paused ? '暂停' : '播放');
                }
            });

            $(document).on('keydown', function (e) {
                // [修复] 移除对 passwordModal 的检查
                if (settingsPanel.is(':visible') || videoPreviewModal.is(':visible') || playlistViewModal.is(':visible')) return;
                if (typeof myhkaudio === 'undefined') return;
                // if (e.key === 'F12') e.preventDefault(); // 允许 F12 打开开发者工具
                switch (e.key) {
                    case ' ': e.preventDefault(); myhkaudio.paused ? myhkaudio.play() : myhkaudio.pause(); showToast(myhkaudio.paused ? '暂停' : '播放'); break;
                    case 'ArrowRight': e.preventDefault(); $('.myhknext').trigger('click'); showToast('下一首'); break;
                    case 'ArrowLeft': e.preventDefault(); $('.myhkprev').trigger('click'); showToast('上一首'); break;
                    case 'ArrowUp': e.preventDefault(); myhkaudio.volume = Math.min(myhkaudio.volume + 0.05, 1.0); showVolumeBar(); break;
                    case 'ArrowDown': e.preventDefault(); myhkaudio.volume = Math.max(myhkaudio.volume - 0.05, 0.0); showVolumeBar(); break;
                    case 'm': // M 键静音/取消静音
                    case 'M':
                        e.preventDefault();
                        myhkaudio.muted = !myhkaudio.muted;
                        showToast(myhkaudio.muted ? '静音' : '取消静音');
                        break;
                    case 's': // S 键打开设置
                    case 'S':
                        e.preventDefault();
                        if (!settingsPanel.is(':visible')) {
                            settingsButton.trigger('click');
                        }
                        break;
                    case 'Escape': // Esc 键关闭设置/预览/播放列表
                        e.preventDefault();
                        if (settingsPanel.is(':visible')) {
                            closeSettingsBtn.trigger('click');
                        } else if (videoPreviewModal.is(':visible')) {
                            closeVideoPreviewBtn.trigger('click');
                        } else if (playlistViewModal.is(':visible')) {
                            closePlaylistViewBtn.trigger('click');
                        }
                        break;
                    case ',': e.preventDefault(); $('#prev-btn').trigger('click'); break;
                    case '.': e.preventDefault(); $('#next-btn').trigger('click'); break;
                }
            });

            // Tab switching logic for both Sidebar and Mobile tabs
            function switchTab(tabId) {
                // Update Sidebar
                $('.sidebar-nav-btn').removeClass('active');
                $(`.sidebar-nav-btn[data-tab="${tabId}"]`).addClass('active');

                // Update Mobile Tabs
                $('.mobile-tab-btn').removeClass('active');
                $(`.mobile-tab-btn[data-tab="${tabId}"]`).addClass('active');

                // Update Content
                $('.tab-content').removeClass('active');
                $('#' + tabId).addClass('active');
            }

            $('.settings-sidebar').on('click', '.sidebar-nav-btn', function () {
                switchTab($(this).data('tab'));
            });

            $('.mobile-tab-bar').on('click', '.mobile-tab-btn', function () {
                switchTab($(this).data('tab'));
            });

            const playlistViewModal = $('#playlist-view-modal');
            const viewPlaylistBtn = $('#view-playlist-btn');
            const closePlaylistViewBtn = $('#close-playlist-view');

            function populateAllPlaylists() {
                const albumContainers = [$('#modal-album-list'), $('#sidebar-album-list')];
                const songContainers = [$('#modal-song-list'), $('#sidebar-song-list')];

                albumContainers.forEach(c => c.empty());
                songContainers.forEach(c => c.empty());

                const albumItems = $('.myhkplaylist .album-list ul li');
                const songItems = $('.myhkplaylist .song-list ul li');

                albumItems.each(function (index) {
                    const albumName = $(this).text().replace(/当前播放\s*>\s*/, '').trim();
                    const isPlaying = $(this).hasClass('myhknow');

                    const albumItem = $(`
                        <div class="playlist-item" data-index="${index}">
                            <span class="playlist-item-name">${albumName}</span>
                        </div>
                    `);
                    if (isPlaying) albumItem.addClass('active-item');

                    albumContainers.forEach(c => c.append(albumItem.clone(true)));
                });

                if (songItems.length === 0) {
                    songContainers.forEach(c => c.append('<p style="color: #888; text-align: center;">此专辑为空</p>'));
                } else {
                    songItems.each(function (index) {
                        const fullText = $(this).text().trim();
                        const parts = fullText.split('-');
                        const name = parts[0] ? parts[0].trim() : fullText;
                        const artist = parts.length > 1 ? parts.slice(1).join('-').trim() : '';
                        const isPlaying = $(this).hasClass('myhknow');
                        const songItem = $(`
                            <div class="song-item" data-index="${index}">
                                <span class="song-item-index">${index + 1}.</span>
                                <div class="song-item-meta">
                                    <span class="song-item-name">${name}</span>
                                    ${artist ? `<span class="song-item-artist">${artist}</span>` : ''}
                                </div>
                            </div>`);
                        if (isPlaying) songItem.addClass('active-item');
                        songContainers.forEach(c => c.append(songItem.clone(true)));
                    });
                }

                if (window.localPlaylist && window.localPlaylist.length > 0) {
                    const localAlbumItem = $(`
                        <div class="playlist-item" data-index="local">
                            <span class="playlist-item-name">本地音乐</span>
                        </div>
                    `);
                    albumContainers.forEach(c => c.prepend(localAlbumItem.clone(true)));

                    if (window.activeAlbumId === 'local') {
                        window.localPlaylist.forEach((track, idx) => {
                            const item = $(`
                                <div class="song-item" data-local-index="${idx}">
                                    <span class="song-item-index">${idx + 1}.</span>
                                    <span class="song-item-name">${track.name}</span>
                                </div>
                            `);
                            if (window.localIndex === idx) item.addClass('active-item');
                            songContainers.forEach(c => c.append(item.clone(true)));
                        });
                    }
                }
            }

            viewPlaylistBtn.on('click', function () {
                populateAllPlaylists();
                playlistViewModal.css('display', 'flex');
                // 强制重绘
                playlistViewModal[0].offsetHeight;
                playlistViewModal.addClass('active');
            });

            closePlaylistViewBtn.on('click', () => {
                playlistViewModal.removeClass('active');
                setTimeout(() => playlistViewModal.hide(), 300);
            });

            function filterPlaylist(term) {
                const t = (term || '').toLowerCase().trim();
                ['#modal-album-list', '#sidebar-album-list'].forEach(sel => {
                    $(sel).children('.playlist-item').each(function () {
                        const text = $(this).text().toLowerCase();
                        $(this).toggle(text.includes(t));
                    });
                });
                ['#modal-song-list', '#sidebar-song-list'].forEach(sel => {
                    $(sel).children('.song-item').each(function () {
                        const text = $(this).text().toLowerCase();
                        $(this).toggle(text.includes(t));
                    });
                });
            }
            $('#playlist-search').on('input', function () { filterPlaylist($(this).val()); });
            $('#sidebar-playlist-search').on('input', function () { filterPlaylist($(this).val()); });

            $('#settings-panel, #playlist-view-modal').on('click', '.playlist-item', function () {
                const targetIndex = $(this).data('index');
                if (targetIndex === 'local') {
                    window.activeAlbumId = 'local';
                    populateAllPlaylists();
                    $('.tab-btn[data-tab="tab-player"]').trigger('click');
                    return;
                }
                const originalAlbumItem = $('.myhkplaylist .album-list ul li').eq(targetIndex);
                if (originalAlbumItem.length) {
                    window.activeAlbumId = null;
                    originalAlbumItem.trigger('click');
                    if (playlistViewModal.is(':visible')) {
                        playlistViewModal.hide();
                    }
                    $('.tab-btn[data-tab="tab-player"]').trigger('click');
                }
            });

            $('#settings-panel, #playlist-view-modal').on('click', '.song-item', function () {
                const targetIndex = $(this).data('index');
                if (window.activeAlbumId === 'local') {
                    const localIdx = $(this).data('local-index');
                    if (typeof localIdx !== 'undefined') {
                        playLocal(localIdx, true);
                        if (playlistViewModal.is(':visible')) playlistViewModal.hide();
                        $('.tab-btn[data-tab="tab-player"]').trigger('click');
                        return;
                    }
                }
                const originalSongItem = $('.myhkplaylist .song-list ul li').eq(targetIndex);
                if (originalSongItem.length && !originalSongItem.hasClass('myhknow')) {
                    window.activeAlbumId = null;
                    originalSongItem.trigger('click');
                    if (playlistViewModal.is(':visible')) {
                        playlistViewModal.hide();
                    }
                    $('.tab-btn[data-tab="tab-player"]').trigger('click');
                }
            });

            const progressBar = $('#progress-bar');
            const progressBarFill = $('#progress-bar-fill');
            const progressBarBuffer = $('#progress-bar-buffer');
            const progressBarHandle = $('#progress-bar-handle');
            const currentTimeEl = $('#current-time');
            const totalTimeEl = $('#total-time');
            let isDraggingProgress = false;

            function formatTime(seconds) {
                if (isNaN(seconds) || seconds < 0) return "0:00";
                const min = Math.floor(seconds / 60);
                const sec = Math.floor(seconds % 60);
                return `${min}:${sec < 10 ? '0' : ''}${sec}`;
            }

            function updateProgressBar() {
                if (typeof myhkaudio === 'undefined' || isDraggingProgress) return;

                const duration = myhkaudio.duration;
                const currentTime = myhkaudio.currentTime;

                if (isNaN(duration) || duration <= 0) {
                    progressBarFill.css('width', '0%');
                    progressBarHandle.css('left', '0%');
                    currentTimeEl.text('0:00');
                    totalTimeEl.text('0:00');
                    return;
                }

                const progressPercent = (currentTime / duration) * 100;
                progressBarFill.css('width', `${progressPercent}%`);
                progressBarHandle.css('left', `${progressPercent}%`);

                // 确保缓冲进度条不会超出播放进度
                let bufferPercent = 0;
                if (myhkaudio.buffered.length > 0) {
                    const bufferEnd = myhkaudio.buffered.end(myhkaudio.buffered.length - 1);
                    bufferPercent = Math.min((bufferEnd / duration) * 100, 100); // 限制最大为 100%
                }
                progressBarBuffer.css('width', `${bufferPercent}%`);


                currentTimeEl.text(formatTime(currentTime));
                totalTimeEl.text(formatTime(duration));
            }

            progressBar.on('mousedown', function (e) {
                if (typeof myhkaudio === 'undefined' || isNaN(myhkaudio.duration) || myhkaudio.duration <= 0) return;
                isDraggingProgress = true;

                const barWidth = progressBar.width();
                let offsetX = e.pageX - progressBar.offset().left;
                offsetX = Math.max(0, Math.min(offsetX, barWidth)); // 限制范围
                const percent = (offsetX / barWidth) * 100;

                progressBarFill.css('width', `${percent}%`);
                progressBarHandle.css('left', `${percent}%`);
                currentTimeEl.text(formatTime((percent / 100) * myhkaudio.duration)); // 拖动时更新时间显示

                $(document).on('mousemove.progress', function (e) {
                    if (!isDraggingProgress) return; // 再次检查标志
                    let newOffsetX = e.pageX - progressBar.offset().left;
                    newOffsetX = Math.max(0, Math.min(newOffsetX, barWidth)); // 限制范围

                    const newPercent = (newOffsetX / barWidth) * 100;
                    progressBarFill.css('width', `${newPercent}%`);
                    progressBarHandle.css('left', `${newPercent}%`);
                    currentTimeEl.text(formatTime((newPercent / 100) * myhkaudio.duration)); // 拖动时更新时间显示
                });

                $(document).on('mouseup.progress', function (e) {
                    if (!isDraggingProgress) return; // 确保只处理一次

                    let finalOffsetX = e.pageX - progressBar.offset().left;
                    finalOffsetX = Math.max(0, Math.min(finalOffsetX, barWidth)); // 限制范围
                    const newTime = (finalOffsetX / barWidth) * myhkaudio.duration;

                    // 确保设置的时间在有效范围内
                    myhkaudio.currentTime = Math.max(0, Math.min(newTime, myhkaudio.duration - 0.1)); // 减去一点以防跳到末尾

                    $(document).off('mousemove.progress mouseup.progress');
                    // 稍微延迟重置标志，以防立即触发 ontimeupdate 导致跳动
                    setTimeout(() => { isDraggingProgress = false; }, 50);
                });
            });

            const CH_FONTS_KEY = 'customChineseFonts';
            const EN_FONTS_KEY = 'customEnglishFonts';
            const ACTIVE_CH_FONT_KEY = 'activeChineseFont';
            const ACTIVE_EN_FONT_KEY = 'activeEnglishFont';

            let chineseFonts = [];
            let englishFonts = [];

            let activeChineseFontName = '默认字体 (Ma Shan Zheng)';
            let activeEnglishFontName = '默认字体 (Roboto)';

            const defaultChineseFonts = [
                { name: '默认字体 (Ma Shan Zheng)', family: "'Ma Shan Zheng'", embed: '', isDefault: true },
                { name: '内置-Zhi Mang Xing', family: "'Zhi Mang Xing'", embed: '', isDefault: true },
                { name: '内置-Liu Jian Mao Cao', family: "'Liu Jian Mao Cao'", embed: '', isDefault: true }
            ];
            const defaultEnglishFonts = [
                { name: '默认字体 (Roboto)', family: "'Roboto'", embed: '', isDefault: true },
                { name: '内置-Source Code Pro', family: "'Source Code Pro'", embed: '', isDefault: true },
                { name: '内置-Caveat', family: "'Caveat'", embed: '', isDefault: true }
            ];

            function saveFontSettings() {
                localStorage.setItem(CH_FONTS_KEY, JSON.stringify(chineseFonts.filter(f => !f.isDefault)));
                localStorage.setItem(EN_FONTS_KEY, JSON.stringify(englishFonts.filter(f => !f.isDefault)));
                localStorage.setItem(ACTIVE_CH_FONT_KEY, activeChineseFontName);
                localStorage.setItem(ACTIVE_EN_FONT_KEY, activeEnglishFontName);
            }

            function applyFonts() {
                const allCustomFonts = [...chineseFonts, ...englishFonts];
                const embedCodes = allCustomFonts.map(font => font.embed).join('');
                $('#custom-font-styles').html(embedCodes);

                const activeChFont = [...defaultChineseFonts, ...chineseFonts].find(f => f.name === activeChineseFontName) || defaultChineseFonts[0];
                const activeEnFont = [...defaultEnglishFonts, ...englishFonts].find(f => f.name === activeEnglishFontName) || defaultEnglishFonts[0];

                document.documentElement.style.setProperty('--chinese-font-family', activeChFont.family);
                document.documentElement.style.setProperty('--english-font-family', activeEnFont.family);

                updateScreensaverFont();
            }

            function populateFontSelects() {
                const chSelect = $('#chinese-font-select');
                const enSelect = $('#english-font-select');

                chSelect.empty();
                enSelect.empty();

                [...defaultChineseFonts, ...chineseFonts].forEach(font => {
                    chSelect.append($('<option>', {
                        value: font.name,
                        text: font.name,
                        selected: font.name === activeChineseFontName
                    }));
                });

                [...defaultEnglishFonts, ...englishFonts].forEach(font => {
                    enSelect.append($('<option>', {
                        value: font.name,
                        text: font.name,
                        selected: font.name === activeEnglishFontName
                    }));
                });

                updateDeleteButtons();
            }

            function updateDeleteButtons() {
                const selectedChFont = [...defaultChineseFonts, ...chineseFonts].find(f => f.name === $('#chinese-font-select').val());
                $('#delete-chinese-font-btn').prop('disabled', !selectedChFont || selectedChFont.isDefault);

                const selectedEnFont = [...defaultEnglishFonts, ...englishFonts].find(f => f.name === $('#english-font-select').val());
                $('#delete-english-font-btn').prop('disabled', !selectedEnFont || selectedEnFont.isDefault);
            }

            function initializeFontSettings() {
                chineseFonts = JSON.parse(localStorage.getItem(CH_FONTS_KEY) || '[]');
                englishFonts = JSON.parse(localStorage.getItem(EN_FONTS_KEY) || '[]');

                activeChineseFontName = localStorage.getItem(ACTIVE_CH_FONT_KEY) || defaultChineseFonts[0].name;
                activeEnglishFontName = localStorage.getItem(ACTIVE_EN_FONT_KEY) || defaultEnglishFonts[0].name;

                populateFontSelects();
                applyFonts();

                $('#add-chinese-font-btn').on('click', function () {
                    const name = $('#new-chinese-font-name').val().trim();
                    const embed = $('#new-chinese-font-embed').val().trim();
                    if (!name || !embed) { showToast('字体名称和嵌入代码不能为空'); return; }
                    if ([...defaultChineseFonts, ...chineseFonts].some(f => f.name === name)) { showToast('已存在同名字体'); return; }

                    // 尝试从嵌入代码中提取 font-family
                    let fontFamily = name; // 默认使用名称
                    const linkMatch = embed.match(/family=([^&:]+)/);
                    const importMatch = embed.match(/font-family:\s*['"]?([^;'"]+)['"]?/);

                    if (linkMatch && linkMatch[1]) {
                        fontFamily = linkMatch[1].replace(/\+/g, ' ');
                    } else if (importMatch && importMatch[1]) {
                        fontFamily = importMatch[1];
                    }

                    chineseFonts.push({ name, family: `'${fontFamily}'`, embed, isDefault: false });
                    activeChineseFontName = name;
                    saveFontSettings();
                    populateFontSelects();
                    applyFonts();
                    $('#new-chinese-font-name').val('');
                    $('#new-chinese-font-embed').val('');
                    showToast('中文字体已添加并启用');
                });

                $('#add-english-font-btn').on('click', function () {
                    const name = $('#new-english-font-name').val().trim();
                    const embed = $('#new-english-font-embed').val().trim();
                    if (!name || !embed) { showToast('字体名称和嵌入代码不能为空'); return; }
                    if ([...defaultEnglishFonts, ...englishFonts].some(f => f.name === name)) { showToast('已存在同名字体'); return; }

                    let fontFamily = name;
                    const linkMatch = embed.match(/family=([^&:]+)/);
                    const importMatch = embed.match(/font-family:\s*['"]?([^;'"]+)['"]?/);

                    if (linkMatch && linkMatch[1]) {
                        fontFamily = linkMatch[1].replace(/\+/g, ' ');
                    } else if (importMatch && importMatch[1]) {
                        fontFamily = importMatch[1];
                    }

                    englishFonts.push({ name, family: `'${fontFamily}'`, embed, isDefault: false });
                    activeEnglishFontName = name;
                    saveFontSettings();
                    populateFontSelects();
                    applyFonts();
                    $('#new-english-font-name').val('');
                    $('#new-english-font-embed').val('');
                    showToast('英文字体已添加并启用');
                });

                $('#chinese-font-select').on('change', function () {
                    activeChineseFontName = $(this).val();
                    saveFontSettings();
                    applyFonts();
                    updateDeleteButtons();
                });

                $('#english-font-select').on('change', function () {
                    activeEnglishFontName = $(this).val();
                    saveFontSettings();
                    applyFonts();
                    updateDeleteButtons();
                });

                $('#delete-chinese-font-btn').on('click', function () {
                    const fontNameToDelete = $('#chinese-font-select').val();
                    chineseFonts = chineseFonts.filter(f => f.name !== fontNameToDelete);
                    if (activeChineseFontName === fontNameToDelete) {
                        activeChineseFontName = defaultChineseFonts[0].name;
                    }
                    saveFontSettings();
                    populateFontSelects();
                    applyFonts();
                    showToast('中文字体已删除');
                });

                $('#delete-english-font-btn').on('click', function () {
                    const fontNameToDelete = $('#english-font-select').val();
                    englishFonts = englishFonts.filter(f => f.name !== fontNameToDelete);
                    if (activeEnglishFontName === fontNameToDelete) {
                        activeEnglishFontName = defaultEnglishFonts[0].name;
                    }
                    saveFontSettings();
                    populateFontSelects();
                    applyFonts();
                    showToast('英文字体已删除');
                });
            }

            const SS_CONFIG_KEY = 'timeScreensaverConfig';
            const screensaver = $('#time-screensaver');
            const timeDisplay = $('#time-display');
            const dateDisplay = $('#date-display');
            let screensaverInterval = null;

            let ssConfig = {
                enabled: false,
                displayMode: 'onpause',
                style: 'modern',
                dateStyle: 'YYYY-MM-DD',
                showSeconds: true,
                showDate: true,
                showLunar: false,
                useCustomFont: false,
                fontSize: 6
            };

            /**
             * 核心农历算法 (全新替换，确保100%准确)
             */
            const lunarCalendar = {
                lunarInfo: [
                    0x04bd8, 0x04ae0, 0x0a570, 0x054d5, 0x0d260, 0x0d950, 0x16554, 0x056a0, 0x09ad0, 0x055d2,
                    0x04ae0, 0x0a5b6, 0x0a4d0, 0x0d250, 0x1d255, 0x0b540, 0x0d6a0, 0x0ada2, 0x095b0, 0x14977,
                    0x04970, 0x0a4b0, 0x0b4b5, 0x06a50, 0x06d40, 0x1ab54, 0x02b60, 0x09570, 0x052f2, 0x04970,
                    0x06566, 0x0d4a0, 0x0ea50, 0x06e95, 0x05ad0, 0x02b60, 0x186e3, 0x092e0, 0x1c8d7, 0x0c950,
                    0x0d4a0, 0x1d8a6, 0x0b550, 0x056a0, 0x1a5b4, 0x025d0, 0x092d0, 0x0d2b2, 0x0a950, 0x0b557,
                    0x06ca0, 0x0b550, 0x15355, 0x04da0, 0x0a5d0, 0x14573, 0x052d0, 0x0a9a8, 0x0e950, 0x06aa0,
                    0x0aea6, 0x0ab50, 0x04b60, 0x0aae4, 0x0a570, 0x05260, 0x0f263, 0x0d950, 0x05b57, 0x056a0,
                    0x096d0, 0x04dd5, 0x04ad0, 0x0a4d0, 0x0d4d4, 0x0d250, 0x0d558, 0x0b540, 0x0b5a0, 0x195a6,
                    0x095b0, 0x049b0, 0x0a974, 0x0a4b0, 0x0b27a, 0x06a50, 0x06d40, 0x0af46, 0x0ab60, 0x09570,
                    0x04af5, 0x04970, 0x064b0, 0x074a3, 0x0ea50, 0x06b58, 0x055c0, 0x0ab60, 0x096d5, 0x092e0,
                    0x0c960, 0x0d954, 0x0d4a0, 0x0da50, 0x07552, 0x056a0, 0x0abb7, 0x025d0, 0x092d0, 0x0cab5,
                    0x0a950, 0x0b4a0, 0x0baa4, 0x0ad50, 0x055d9, 0x04ba0, 0x0a5b0, 0x15176, 0x052b0, 0x0a930,
                    0x07954, 0x06aa0, 0x0ad50, 0x05b52, 0x04b60, 0x0a6e6, 0x0a4e0, 0x0d260, 0x0ea65, 0x0d530,
                    0x05aa0, 0x076a3, 0x096d0, 0x04bd7, 0x04ad0, 0x0a4d0, 0x1d0b6, 0x0d250, 0x0d520, 0x0dd45,
                    0x0b5a0, 0x056d0, 0x055b2, 0x049b0, 0x0a577, 0x0a4b0, 0x0aa50, 0x1b255, 0x06d20, 0x0ada0
                ],
                nStr1: '日一二三四五六七八九十',
                nStr2: ['初', '十', '廿', '三'],
                nStr3: ['正', '二', '三', '四', '五', '六', '七', '八', '九', '十', '冬', '腊'],

                leapMonth: function (y) { return (this.lunarInfo[y - 1900] & 0xf); },
                leapDays: function (y) { return (this.leapMonth(y) ? ((this.lunarInfo[y - 1900] & 0x10000) ? 30 : 29) : 0); },
                monthDays: function (y, m) { return ((this.lunarInfo[y - 1900] & (0x10000 >> m)) ? 30 : 29); },
                lYearDays: function (y) {
                    let i, sum = 348;
                    for (i = 0x8000; i > 0x8; i >>= 1) sum += (this.lunarInfo[y - 1900] & i) ? 1 : 0;
                    return (sum + this.leapDays(y));
                },
                solarToLunar: function (solarDate) {
                    let i, leap = 0, temp = 0;
                    let baseDate = new Date(1900, 0, 31);
                    let offset = (solarDate.getTime() - baseDate.getTime()) / 86400000;

                    let y;
                    for (y = 1900; y < 2050 && offset > 0; y++) {
                        temp = this.lYearDays(y);
                        offset -= temp;
                    }
                    if (offset < 0) {
                        offset += temp;
                        y--;
                    }

                    let year = y;
                    leap = this.leapMonth(year);
                    let isLeap = false;

                    let m;
                    for (m = 1; m < 13 && offset > 0; m++) {
                        if (leap > 0 && m === (leap + 1) && !isLeap) {
                            --m;
                            isLeap = true;
                            temp = this.leapDays(year);
                        } else {
                            temp = this.monthDays(year, m);
                        }
                        if (isLeap && m === (leap + 1)) isLeap = false;
                        offset -= temp;
                    }

                    if (offset === 0 && leap > 0 && m === leap + 1) {
                        if (isLeap) {
                            isLeap = false;
                        } else {
                            isLeap = true;
                            --m;
                        }
                    }
                    if (offset < 0) {
                        offset += temp;
                        --m;
                    }

                    let month = m;
                    let day = offset + 1;

                    const monthCn = (isLeap ? '闰' : '') + this.nStr3[month - 1] + '月';
                    let dayCn;
                    if (day === 10) { dayCn = '初十'; }
                    else if (day === 20) { dayCn = '二十'; }
                    else if (day === 30) { dayCn = '三十'; }
                    else {
                        dayCn = this.nStr2[Math.floor((day - 1) / 10)] + this.nStr1.charAt(day % 10);
                    }

                    return { monthCn: monthCn, dayCn: dayCn };
                }
            };

            const lunarData = {
                getLunar: function (date) { return lunarCalendar.solarToLunar(date); },
                zhi: "子丑寅卯辰巳午未申酉戌亥"
            };

            /**
             * 更新时间屏保
             */
            function updateScreensaver() {
                if (!ssConfig.enabled) return;
                const now = new Date();
                let timeStr = '', dateStr = '';

                const hours = now.getHours();
                const minutes = now.getMinutes();
                const seconds = now.getSeconds();

                switch (ssConfig.style) {
                    case 'ancient':
                        const ancientHourIndex = Math.floor((hours + 1) / 2) % 12;
                        timeStr = lunarData.zhi[ancientHourIndex] + '时';
                        timeStr += `<span class="ancient-seconds ancient-digit">${String(minutes).padStart(2, '0')}</span>`;
                        if (ssConfig.showSeconds) {
                            timeStr += `<span class="ancient-seconds ancient-digit">${String(seconds).padStart(2, '0')}</span>`;
                        }
                        break;
                    case 'western':
                        const ampm = hours >= 12 ? 'PM' : 'AM';
                        const westernHours = hours % 12 || 12;
                        timeStr = `${String(westernHours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                        if (ssConfig.showSeconds) {
                            timeStr += `:${String(seconds).padStart(2, '0')}`;
                        } else {
                            timeStr += `<span style="visibility:hidden">:00</span>`;
                        }
                        timeStr += ` ${ampm}`;
                        break;
                    case 'modern':
                    default:
                        timeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
                        if (ssConfig.showSeconds) {
                            timeStr += `:${String(seconds).padStart(2, '0')}`;
                        } else {
                            timeStr += `<span style="visibility:hidden">:00</span>`; // 保持宽度占位
                        }
                        break;
                }

                if (ssConfig.showDate) {
                    const year = now.getFullYear();
                    const month = now.getMonth() + 1;
                    const day = now.getDate();
                    const weekday = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"][now.getDay()];

                    switch (ssConfig.dateStyle) {
                        case 'MM-DD-YYYY':
                            dateStr = `${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}-${year}`;
                            break;
                        case 'full':
                            dateStr = `${year}年${month}月${day}日 ${weekday}`;
                            break;
                        case 'YYYY-MM-DD':
                        default:
                            dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                            break;
                    }

                    if (ssConfig.style === 'ancient') {
                        dateStr = dateStr.replace(/(\d+)/g, '<span class="ancient-digit">$1</span>');
                    }

                    if (ssConfig.showLunar) {
                        const lunar = lunarData.getLunar(now);
                        dateStr += ` (农历 ${lunar.monthCn}${lunar.dayCn})`;
                    }
                }

                timeDisplay.html(timeStr);
                dateDisplay.html(dateStr);
            }

            // --- [修复] 切歌Bug修复：添加 isChangingTrack 判断 ---
            function updateScreensaverVisibility() {
                // 在切歌过程中仅当播放器仍在播放时跳过；如果用户暂停则仍显示
                if (isChangingTrack && ssConfig.displayMode === 'onpause' && typeof myhkaudio !== 'undefined' && !myhkaudio.paused) {
                    return;
                }

                if (!ssConfig.enabled) {
                    screensaver.removeClass('visible');
                    // 确保隐藏时 display 也设为 none
                    setTimeout(() => {
                        if (!screensaver.hasClass('visible')) {
                            screensaver.css('display', 'none');
                        }
                    }, 500);
                    return;
                }

                const isPaused = (typeof myhkaudio !== 'undefined' && myhkaudio.paused);

                if (ssConfig.displayMode === 'always' || (ssConfig.displayMode === 'onpause' && isPaused)) {
                    screensaver.css('display', 'flex');
                    setTimeout(() => {
                        // 再次检查条件，防止在延迟期间状态改变
                        const currentIsPaused = (typeof myhkaudio !== 'undefined' && myhkaudio.paused);
                        if (ssConfig.displayMode === 'always' || (ssConfig.displayMode === 'onpause' && currentIsPaused)) {
                            screensaver.addClass('visible');
                        } else {
                            screensaver.css('display', 'none'); // 如果条件不再满足，则隐藏
                        }
                    }, 10); // 短暂延迟确保 display:flex 生效
                } else {
                    screensaver.removeClass('visible');
                    setTimeout(() => {
                        if (!screensaver.hasClass('visible')) {
                            screensaver.css('display', 'none');
                        }
                    }, 500); // 与CSS过渡时间匹配
                }
            }

            function updateScreensaverFont() {
                let fontFamily = 'var(--chinese-font-family)'; // 默认字体
                if (ssConfig.useCustomFont) {
                    // 如果勾选了“应用字体”，则使用当前选择的中文字体
                    const activeChFont = [...defaultChineseFonts, ...chineseFonts].find(f => f.name === activeChineseFontName) || defaultChineseFonts[0];
                    fontFamily = activeChFont.family;
                }
                // 如果没有勾选，则依赖于屏保样式的 CSS 规则来设置字体
                document.documentElement.style.setProperty('--screensaver-font-family', fontFamily);
                // 应用样式会重新渲染，不需要手动设置 font-family
                applyScreensaverConfig(); // 重新应用配置以更新样式类
            }

            function saveScreensaverConfig() {
                localStorage.setItem(SS_CONFIG_KEY, JSON.stringify(ssConfig));
            }

            function applyScreensaverConfig() {
                if (ssConfig.enabled && !screensaverInterval) {
                    screensaverInterval = setInterval(updateScreensaver, ssConfig.showSeconds ? 1000 : 10000); // 如果不显示秒，降低更新频率
                    updateScreensaver(); // 立即执行一次
                } else if (!ssConfig.enabled && screensaverInterval) {
                    clearInterval(screensaverInterval);
                    screensaverInterval = null;
                } else if (ssConfig.enabled && screensaverInterval) {
                    // 如果已启用且定时器存在，根据 showSeconds 调整频率
                    clearInterval(screensaverInterval);
                    screensaverInterval = setInterval(updateScreensaver, ssConfig.showSeconds ? 1000 : 10000);
                }

                // 确保清除所有旧样式，然后添加正确的样式类
                screensaver.removeClass('style-modern style-ancient style-western');
                if (ssConfig.style === 'modern') {
                    screensaver.addClass('style-modern');
                } else if (ssConfig.style === 'ancient') {
                    screensaver.addClass('style-ancient');
                } else if (ssConfig.style === 'western') {
                    screensaver.addClass('style-western');
                }

                $('#time-display').css('font-size', ssConfig.fontSize + 'vw');
                $('#date-display').css('font-size', (ssConfig.fontSize / 3) + 'vw');

                // updateScreensaverFont(); // 这个调用被移动到 use-custom-font 的 change 事件里
                updateScreensaverVisibility();
            }

            function loadAndBindScreensaverSettings() {
                const savedConfig = localStorage.getItem(SS_CONFIG_KEY);
                if (savedConfig) {
                    try {
                        ssConfig = { ...ssConfig, ...JSON.parse(savedConfig) };
                    } catch (e) { console.error("加载屏保设置失败:", e); }
                }

                $('#screensaver-toggle').prop('checked', ssConfig.enabled);
                $('.screensaver-btn').removeClass('active');
                $(`.screensaver-btn[data-mode="${ssConfig.displayMode}"]`).addClass('active');
                $('#screensaver-style-select').val(ssConfig.style);
                $('#screensaver-date-style-select').val(ssConfig.dateStyle);
                $('#ss-show-seconds').prop('checked', ssConfig.showSeconds);
                $('#ss-show-date').prop('checked', ssConfig.showDate);
                $('#ss-show-lunar').prop('checked', ssConfig.showLunar);
                $('#ss-use-custom-font').prop('checked', ssConfig.useCustomFont);
                $('#ss-font-size').val(ssConfig.fontSize);
                $('#ss-font-size-value').text(ssConfig.fontSize + 'vw');

                // 在绑定事件前先应用一次配置
                applyScreensaverConfig();
                updateScreensaverFont(); // 确保字体在初始化时正确应用

                $('#screensaver-toggle').on('change', function () {
                    ssConfig.enabled = $(this).is(':checked');
                    saveScreensaverConfig();
                    applyScreensaverConfig();
                });
                $('.screensaver-btn').on('click', function () {
                    $('.screensaver-btn').removeClass('active');
                    $(this).addClass('active');
                    ssConfig.displayMode = $(this).data('mode');
                    saveScreensaverConfig();
                    updateScreensaverVisibility(); // 只更新可见性
                });
                $('#screensaver-style-select, #screensaver-date-style-select, #ss-show-seconds, #ss-show-date, #ss-show-lunar').on('change', function () {
                    ssConfig.style = $('#screensaver-style-select').val();
                    ssConfig.dateStyle = $('#screensaver-date-style-select').val();
                    ssConfig.showSeconds = $('#ss-show-seconds').is(':checked');
                    ssConfig.showDate = $('#ss-show-date').is(':checked');
                    ssConfig.showLunar = $('#ss-show-lunar').is(':checked');

                    saveScreensaverConfig();
                    applyScreensaverConfig();
                    updateScreensaver(); // 立即更新显示
                });
                $('#ss-use-custom-font').on('change', function () {
                    ssConfig.useCustomFont = $(this).is(':checked');
                    saveScreensaverConfig();
                    updateScreensaverFont(); // 只更新字体
                });
                $('#ss-font-size').on('input', function () {
                    ssConfig.fontSize = $(this).val();
                    $('#ss-font-size-value').text(ssConfig.fontSize + 'vw');
                    applyScreensaverConfig();
                });
                $('#ss-font-size').on('change', function () {
                    saveScreensaverConfig(); // 仅在释放滑块后保存
                });
                $('#reset-screensaver').on('click', function () {
                    ssConfig = {
                        enabled: false,
                        displayMode: 'onpause',
                        style: 'modern',
                        dateStyle: 'YYYY-MM-DD',
                        showSeconds: true,
                        showDate: true,
                        showLunar: false,
                        useCustomFont: false,
                        fontSize: 10
                    };
                    saveScreensaverConfig();
                    applyScreensaverConfig();
                    updateScreensaver();
                    showToast('时间屏保已恢复默认');
                });
            }

            // 高级设置功能实现
            function initializeAdvancedSettings() {
                // 保持屏幕常亮设置
                const wakeLockCheckbox = document.getElementById('enable-wake-lock');
                if (wakeLockCheckbox) {
                    const savedWakeLock = localStorage.getItem('enableWakeLock');
                    // 默认启用屏幕常亮
                    wakeLockCheckbox.checked = savedWakeLock !== 'false';

                    wakeLockCheckbox.addEventListener('change', function () {
                        localStorage.setItem('enableWakeLock', this.checked);
                        if (this.checked && typeof myhkaudio !== 'undefined' && !myhkaudio.paused) {
                            requestWakeLock();
                        } else if (!this.checked && wakeLock) {
                            releaseWakeLock();
                        }
                        showToast(this.checked ? '已启用屏幕常亮' : '已禁用屏幕常亮');
                    });

                    // 初始化时，如果设置为启用并且音乐正在播放，则请求锁
                    if (wakeLockCheckbox.checked && typeof myhkaudio !== 'undefined' && !myhkaudio.paused) {
                        requestWakeLock();
                    }
                }

                // 减少动画效果设置
                const reduceAnimationsCheckbox = document.getElementById('reduce-animations');
                if (reduceAnimationsCheckbox) {
                    const savedReduceAnimations = localStorage.getItem('reduceAnimations');
                    reduceAnimationsCheckbox.checked = savedReduceAnimations === 'true';

                    reduceAnimationsCheckbox.addEventListener('change', function () {
                        localStorage.setItem('reduceAnimations', this.checked);
                        document.body.classList.toggle('reduce-animations', this.checked);
                        showToast(this.checked ? '已减少动画效果' : '已启用完整动画');
                    });

                    // 应用保存的设置
                    if (reduceAnimationsCheckbox.checked) {
                        document.body.classList.add('reduce-animations');
                    }
                }

                // 视频质量设置
                const videoQualitySelect = document.getElementById('video-quality');
                if (videoQualitySelect) {
                    const savedVideoQuality = localStorage.getItem('videoQuality') || 'medium';
                    videoQualitySelect.value = savedVideoQuality;

                    videoQualitySelect.addEventListener('change', function () {
                        localStorage.setItem('videoQuality', this.value);
                        applyVideoQuality(this.value);
                        showToast(`视频质量已设置为: ${this.options[this.selectedIndex].text}`);
                    });

                    // 应用保存的设置
                    applyVideoQuality(savedVideoQuality);
                }

                // 数据节省模式设置
                const dataSaverCheckbox = document.getElementById('mobile-data-saver');
                if (dataSaverCheckbox) {
                    const savedDataSaver = localStorage.getItem('mobileDataSaver');
                    dataSaverCheckbox.checked = savedDataSaver === 'true';

                    dataSaverCheckbox.addEventListener('change', function () {
                        localStorage.setItem('mobileDataSaver', this.checked);
                        applyDataSaverMode(this.checked);
                        showToast(this.checked ? '已启用数据节省模式' : '已禁用数据节省模式');
                    });

                    // 应用保存的设置
                    if (dataSaverCheckbox.checked) {
                        applyDataSaverMode(true);
                    }
                }

                // 触控按钮大小设置
                const touchControlsSizeSelect = document.getElementById('touch-controls-size');
                if (touchControlsSizeSelect) {
                    const savedTouchSize = localStorage.getItem('touchControlsSize') || 'medium';
                    touchControlsSizeSelect.value = savedTouchSize;

                    touchControlsSizeSelect.addEventListener('change', function () {
                        localStorage.setItem('touchControlsSize', this.value);
                        applyTouchControlsSize(this.value);
                        showToast(`触控按钮大小已设置为: ${this.options[this.selectedIndex].text}`);
                    });

                    // 应用保存的设置
                    applyTouchControlsSize(savedTouchSize);
                }

                // --- [修复] 绑定数据管理按钮 ---
                $('#export-settings-btn').on('click', exportSettings);
                $('#import-settings-btn').on('click', () => $('#import-settings-file').click());
                $('#import-settings-file').on('change', importSettings);
                $('#clear-cache-btn').on('click', clearBackgroundCache);
                $('#reset-settings-btn').on('click', resetAllSettings);
                // --- 结束修复 ---

                // 绑定全屏按钮
                $('#fullscreen-btn').on('click', toggleFullscreen);
            }

            // 全屏功能实现
            function toggleFullscreen() {
                if (!document.fullscreenElement &&
                    !document.mozFullScreenElement &&
                    !document.webkitFullscreenElement &&
                    !document.msFullscreenElement) {
                    // 进入全屏
                    if (document.documentElement.requestFullscreen) {
                        document.documentElement.requestFullscreen();
                    } else if (document.documentElement.msRequestFullscreen) {
                        document.documentElement.msRequestFullscreen();
                    } else if (document.documentElement.mozRequestFullScreen) {
                        document.documentElement.mozRequestFullScreen();
                    } else if (document.documentElement.webkitRequestFullscreen) {
                        document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                    }
                    showToast("已进入全屏模式");
                } else {
                    // 退出全屏
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                    } else if (document.msExitFullscreen) {
                        document.msExitFullscreen();
                    } else if (document.mozCancelFullScreen) {
                        document.mozCancelFullScreen();
                    } else if (document.webkitExitFullscreen) {
                        document.webkitExitFullscreen();
                    }
                    showToast("已退出全屏模式");
                }
            }

            // 应用视频质量设置
            function applyVideoQuality(quality) {
                const video = document.getElementById('bg-video');
                if (video) {
                    // 根据质量设置调整视频属性
                    switch (quality) {
                        case 'high':
                            video.style.filter = 'none';
                            // 可以考虑移除 playbackRate 或其他优化
                            break;
                        case 'medium':
                            video.style.filter = 'blur(0.5px)';
                            // 可以考虑稍微降低播放速率 video.playbackRate = 0.95;
                            break;
                        case 'low':
                            video.style.filter = 'blur(1px) brightness(0.8)';
                            // video.playbackRate = 0.9; // 进一步降低
                            // video.muted = true; // 如果不需要声音
                            break;
                    }
                }
            }

            // 应用数据节省模式
            function applyDataSaverMode(enabled) {
                const video = document.getElementById('bg-video');
                if (video && enabled) {
                    video.pause(); // 暂停视频
                    video.style.display = 'none'; // 隐藏视频元素
                    bgContainer.css('background-image', 'none'); // 清除背景图片
                    $('body').css('background', 'linear-gradient(135deg, #1e3c72 0%, #2a5298 100%)'); // 设置纯色或渐变背景
                    stopBackgroundChangeTimer(); // 停止背景切换
                } else if (video && !enabled) {
                    $('body').css('background', ''); // 恢复默认背景色
                    video.style.display = 'block'; // 重新显示视频元素
                    // 不需要立即播放，playRandomBackground 会处理
                    playRandomBackground(); // 重新开始背景播放
                }
            }

            // 应用触控按钮大小
            function applyTouchControlsSize(size) {
                // 查找所有需要调整大小的按钮或控件
                const controls = document.querySelectorAll('.control-btn, .play-mode-btn, .tab-btn, .screensaver-btn, .form-group button, .settings-section > button, .danger-btn');
                controls.forEach(btn => {
                    btn.classList.remove('touch-small', 'touch-medium', 'touch-large');
                    btn.classList.add(`touch-${size}`);
                });
            }

            // --- [修复] 新增数据管理功能 ---
            function exportSettings() {
                const settings = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // 排除播放器本身可能存储的一些内部状态（如果知道的话）
                    // if (key.startsWith('myhk_')) continue; 
                    settings[key] = localStorage.getItem(key);
                }
                const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `music-video-settings-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("设置已导出");
            }

            function importSettings(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function (e) {
                    try {
                        const settings = JSON.parse(e.target.result);
                        // 清除现有设置（可选，或逐一覆盖）
                        // localStorage.clear(); // 如果要完全替换
                        for (const key in settings) {
                            if (Object.hasOwnProperty.call(settings, key)) {
                                localStorage.setItem(key, settings[key]);
                            }
                        }
                        showToast("设置已导入，正在刷新...");
                        setTimeout(() => location.reload(), 1500);
                    } catch (err) {
                        showToast("导入失败：文件格式错误");
                        console.error("Import failed:", err);
                    } finally {
                        // 清空文件输入，以便可以再次导入相同文件
                        event.target.value = null;
                    }
                };
                reader.readAsText(file);
            }

            function clearBackgroundCache() {
                // 删除背景列表相关的 localStorage 项
                localStorage.removeItem(BG_LIST_KEY);
                localStorage.removeItem(BG_ENABLED_MAP_KEY);
                localStorage.removeItem(BG_PLAYBACK_MODE_KEY);
                localStorage.removeItem(GIST_URL_KEY);

                // 重新加载默认列表并应用
                loadBackgroundList(); // 会加载默认列表
                populateBackgroundList(); // 更新设置界面的列表显示
                playRandomBackground(); // 播放一个新的背景

                showToast("背景缓存已清除");
            }

            function resetAllSettings() {
                if (confirm("确定要重置所有设置吗？这将清除所有自定义字体、背景和偏好设置，并刷新页面。")) {
                    localStorage.clear();
                    showToast("所有设置已重置，即将刷新...");
                    setTimeout(() => location.reload(), 1500);
                }
            }
            // 创建隐藏的文件输入元素用于导入
            const importFileInput = document.createElement('input');
            importFileInput.type = 'file';
            importFileInput.accept = '.json';
            importFileInput.id = 'import-settings-file';
            importFileInput.style.display = 'none';
            document.body.appendChild(importFileInput);
            // --- 结束修复 ---

            function initializeAppearanceSettings() {
                const LYRIC_ANIM_KEY = 'lyricAnimationPreference';
                const lyricAnimSelect = $('#lyric-animation-select');

                function applyLyricAnimationSetting() {
                    const savedAnim = localStorage.getItem(LYRIC_ANIM_KEY) || 'subtle'; // Default to subtle
                    $('body').removeClass('lyric-anim-dynamic lyric-anim-subtle').addClass('lyric-anim-' + savedAnim);
                    lyricAnimSelect.val(savedAnim);
                }

                lyricAnimSelect.on('change', function () {
                    const selectedAnim = $(this).val();
                    localStorage.setItem(LYRIC_ANIM_KEY, selectedAnim);
                    applyLyricAnimationSetting();
                    showToast(`歌词动画已切换为: ${$(this).find('option:selected').text()}`);
                });

                // Initial load
                applyLyricAnimationSetting();
                $('#reset-lyric-anim').on('click', function () {
                    localStorage.setItem(LYRIC_ANIM_KEY, 'subtle');
                    applyLyricAnimationSetting();
                    showToast('已重置为默认: 微妙');
                });
            }

            // --- [修复] 添加页面可见性 API 处理背景定时器 ---
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    // 页面隐藏时，暂停计时器
                    if (backgroundChangeTimer) {
                        clearTimeout(backgroundChangeTimer);
                        backgroundChangeTimer = null; // 清除 ID
                        const elapsed = Date.now() - timerStartTime;
                        timerRemaining = Math.max(0, (bgChangeInterval * 1000) - elapsed); // 计算剩余时间
                        // console.log("Timer paused, remaining:", timerRemaining);
                    }
                } else if (document.visibilityState === 'visible') {
                    // 页面可见时，恢复计时器
                    const currentBg = currentBgIndex !== -1 ? backgroundList[currentBgIndex] : null;
                    // 只有当当前是图片背景且设置了切换间隔时才恢复
                    if (currentBg && currentBg.type === 'image' && bgChangeInterval > 0 && timerRemaining > 0) {
                        // console.log("Timer resumed, remaining:", timerRemaining);
                        backgroundChangeTimer = setTimeout(playRandomBackground, timerRemaining);
                        timerStartTime = Date.now() - (bgChangeInterval * 1000 - timerRemaining); // 调整开始时间
                        timerRemaining = 0; // 清空剩余时间
                    } else if (currentBg && currentBg.type === 'image' && bgChangeInterval > 0 && !backgroundChangeTimer) {
                        // 如果定时器因其他原因停止（如切换到间隔为0），重新启动
                        startBackgroundChangeTimer();
                    }
                }
            });


            // --- 初始化 ---
            initializePlayerIntegration();
            initializeFontSettings();
            initializeAppearanceSettings();
            initializeBgSettings(); // 会调用 playRandomBackground
            loadAndBindScreensaverSettings();
            initializeAdvancedSettings();

            // 注册Service Worker支持PWA (改进版)
            if ('serviceWorker' in navigator) {
                // 改进的Service Worker代码
                const swCode = `
// 改进的 Service Worker - 支持更好的缓存策略
const CACHE_NAME = "music-video-cache-v2";
const DYNAMIC_CACHE = "music-video-dynamic-v2";

// 预缓存的资源
const precacheResources = [
  './',
  './winlyrics-video.html'
];

// 安装事件 - 预缓存资源
self.addEventListener('install', (event) => {
  console.log('[SW] Installing service worker...');
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then((cache) => {
        console.log('[SW] Precaching resources');
        return cache.addAll(precacheResources);
      })
      .then(() => self.skipWaiting()) // 立即激活新的 SW
  );
});

// 激活事件 - 清理旧缓存
self.addEventListener('activate', (event) => {
  console.log('[SW] Activating service worker...');
  event.waitUntil(
    caches.keys().then((keyList) => {
      return Promise.all(
        keyList.map((key) => {
          if (key !== CACHE_NAME && key !== DYNAMIC_CACHE) {
            console.log('[SW] Deleting old cache:', key);
            return caches.delete(key);
          }
        })
      );
    }).then(() => self.clients.claim()) // 接管所有页面
  );
});

// 请求拦截 - Network First with Cache Fallback (适合动态内容)
self.addEventListener('fetch', (event) => {
  // 跳过非 HTTP(S) 请求
  if (!event.request.url.startsWith('http')) {
    return;
  }

  event.respondWith(
    fetch(event.request)
      .then((response) => {
        // 成功获取网络资源，更新缓存
        if (response && response.status === 200) {
          const responseToCache = response.clone();
          caches.open(DYNAMIC_CACHE).then((cache) => {
            cache.put(event.request, responseToCache);
          });
        }
        return response;
      })
      .catch(() => {
        // 网络失败，尝试从缓存获取
        return caches.match(event.request).then((cachedResponse) => {
          if (cachedResponse) {
            return cachedResponse;
          }
          // 如果缓存也没有，返回离线页面或默认响应
          return new Response('离线模式 - 资源不可用', {
            status: 503,
            statusText: 'Service Unavailable'
          });
        });
      })
  );
});
    `;

                // 创建Blob并注册Service Worker
                const swBlob = new Blob([swCode], { type: 'application/javascript' });
                const swURL = URL.createObjectURL(swBlob);
                navigator.serviceWorker.register(swURL)
                    .then(function (registration) {
                        console.log('✅ Service Worker 注册成功，范围:', registration.scope);
                        URL.revokeObjectURL(swURL);
                    })
                    .catch(function (error) {
                        console.error('❌ Service Worker 注册失败:', error);
                    });
            }

            // PWA 安装提示处理
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                // 阻止默认的安装提示
                e.preventDefault();
                deferredPrompt = e;
                console.log('💡 PWA 可以安装');

                // 可以在这里显示自定义的安装按钮
                // 或者在右键菜单中添加安装选项
                showToast('💡 此应用可以安装到您的设备', 5000);
            });

            // 监听应用安装成功
            window.addEventListener('appinstalled', () => {
                console.log('✅ PWA 已成功安装');
                showToast('✅ 应用已成功安装！');
                deferredPrompt = null;
            });

            // 同步播放列表内容到设置标签页
            function syncPlaylistToSettings() {
                // 将模态框的播放列表内容复制到设置标签页
                const modalAlbumList = $('#modal-album-list').html();
                const modalSongList = $('#modal-song-list').html();

                $('#settings-album-list').html(modalAlbumList || '<p style="color: #888; text-align: center; padding: 20px;">暂无专辑</p>');
                $('#settings-song-list').html(modalSongList || '<p style="color: #888; text-align: center; padding: 20px;">暂无歌曲</p>');
            }

            // 监听 MutationObserver 来自动同步播放列表更新
            const modalAlbumObserver = new MutationObserver(function () {
                if ($('#tab-playlist').hasClass('active')) {
                    syncPlaylistToSettings();
                }
            });

            if ($('#modal-album-list').length > 0) {
                modalAlbumObserver.observe(document.getElementById('modal-album-list'), {
                    childList: true,
                    subtree: true
                });
            }

            // 当切换到播放列表标签时同步内容
            $('[data-tab="tab-playlist"]').on('click', function () {
                setTimeout(syncPlaylistToSettings, 100);
            });

            // 设置标签页的搜索功能
            $('#settings-playlist-search').on('input', function () {
                const searchTerm = $(this).val().toLowerCase();

                // 搜索专辑
                $('#settings-album-list .album-item').each(function () {
                    const albumName = $(this).text().toLowerCase();
                    $(this).toggle(albumName.includes(searchTerm));
                });

                // 搜索歌曲
                $('#settings-song-list .song-item').each(function () {
                    const songText = $(this).text().toLowerCase();
                    $(this).toggle(songText.includes(searchTerm));
                });
            });

            if (!localStorage.getItem('settingsHintShown')) {
                setTimeout(() => {
                    showToast("提示: 移动鼠标到右上角可设置", 8000);
                    localStorage.setItem('settingsHintShown', 'true');
                }, 4500);
            }
        });
    </script>

</body>

</html>
